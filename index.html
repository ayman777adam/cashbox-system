<!DOCTYPE html>

<html dir="rtl" lang="ar">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Ù†Ø¸Ø§Ù… ØªÙ‚ÙÙŠÙ„Ø© Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ â€“ Ø£ÙŠÙ…Ù† Ø£Ø¨Ùˆ ÙˆØ±Ø¯Ù‡</title>
<style>
:root{
  --bg:#0f172a; --bg2:#0b132b;
  --panel:rgba(17,25,40,.85); --panel-strong:rgba(17,25,40,.95);
  --border:rgba(255,255,255,.08);
  --text:#e6edf3; --muted:#9fb3c8;
  --primary:#00c2ff; --primary-2:#3ea8ff;
  --gold:#f5c542; --gold-soft:#ffdf8a;
  --good:#22c55e; --bad:#ef4444;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family: system-ui, -apple-system, "Segoe UI", Arial, Tahoma;
  color:var(--text);
  background:
    radial-gradient(1200px 600px at 10% 10%, rgba(0,194,255,.08), transparent 60%),
    radial-gradient(1200px 600px at 90% 0%, rgba(245,197,66,.07), transparent 60%),
    linear-gradient(135deg,var(--bg2) 0%,var(--bg) 60%,var(--bg2) 100%);
}
body.locked *:not(#login):not(#login *){
  pointer-events:none; opacity:.5;
}

/* ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ */
#login{
  position:fixed; inset:0; z-index:1000;
  display:flex; align-items:center; justify-content:center;
  background:
    radial-gradient(800px 400px at 15% 25%, rgba(0,194,255,.09), transparent 60%),
    radial-gradient(800px 400px at 85% 15%, rgba(245,197,66,.08), transparent 60%),
    linear-gradient(135deg,#0b132b 0%,#0f172a 60%,#0b132b 100%);
  animation:loginBg 12s linear infinite alternate;
}
@keyframes loginBg{from{background-position:0 0, 0 0, 0 0} to{background-position:20px -20px, -20px 20px, 0 0}}
.login-card{
  width:min(92%,440px); padding:24px 20px; border-radius:18px;
  border:1px solid var(--border);
  background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
  backdrop-filter: blur(12px); text-align:center; position:relative; overflow:hidden;
  box-shadow:0 30px 80px rgba(0,0,0,.45);
}
.login-card::before{
  content:""; position:absolute; inset:auto -40% auto -40%; top:-60%;
  height:8px; background:linear-gradient(90deg, transparent, var(--gold), transparent);
  filter:blur(1px); opacity:.35; animation:shimmer 6s linear infinite;
}
@keyframes shimmer{0%{transform:translateX(-60%)} 100%{transform:translateX(60%)}}
.login-title{font-weight:900; font-size:26px; color:var(--gold); margin-bottom:6px}
.login-greet{font-size:14px; color:var(--muted); margin-bottom:12px}
.login-sub{font-size:15px; color:#eaeaea; margin:8px 0 12px}
.login-input{width:100%; padding:12px; border-radius:12px; font-size:16px; text-align:center; background:rgba(0,0,0,.35); color:var(--text); border:1px solid var(--border); outline:none}
.btn{border:none; border-radius:14px; padding:10px 16px; font-weight:800; display:inline-flex; gap:8px; align-items:center; cursor:pointer; transition:.18s}
.btn:hover{transform:translateY(-1px)}
.btn:disabled{opacity:.55; cursor:not-allowed}
.btn-gold{background:linear-gradient(135deg,var(--gold),#e9b12d); color:#251c07; box-shadow:0 10px 20px rgba(245,197,66,.18)}
.btn-blue{background:linear-gradient(135deg,var(--primary),var(--primary-2)); color:#06202b; box-shadow:0 10px 20px rgba(0,194,255,.2)}
.btn-danger{background:linear-gradient(135deg,#ef4444,#dc2626); color:#fff; box-shadow:0 10px 20px rgba(239,68,68,.18)}
.login-enter{width:100%; margin-top:12px; position:relative; overflow:hidden}
.login-enter::after{content:""; position:absolute; inset:0; background:linear-gradient(90deg, transparent, rgba(255,255,255,.25), transparent); transform:translateX(-100%); transition:transform .6s}
.login-enter:hover::after{ transform:translateX(100%) }

/* Header */
header{
  position:sticky; top:0; z-index:20;
  background:linear-gradient(180deg,var(--panel-strong), rgba(17,25,40,.7));
  backdrop-filter: blur(10px);
  border-bottom:1px solid var(--border);
  padding:14px 18px; display:flex; justify-content:space-between; align-items:center; gap:10px;
  flex-wrap:wrap;
}
.header-left .title{font-size:22px; font-weight:800; color:var(--gold); display:flex; gap:8px; align-items:center}
.header-left .subtitle{font-size:13px; color:var(--muted); margin-top:2px}
.header-left .phone{font-size:12px; color:#ffde8a}
.user-controls{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
.user-pill{background:linear-gradient(135deg, rgba(0,194,255,.15), rgba(245,197,66,.12)); border:1px solid var(--border); padding:6px 12px; border-radius:999px; font-weight:800; color:#eaf6ff; font-size:13px}
.last-update{font-size:12px; color:var(--gold-soft); opacity:.95; margin-top:2px}
#logoutBtn{background:linear-gradient(135deg,#f97316,#ea580c); color:#fff; font-weight:900; border-radius:12px; padding:10px 16px; box-shadow:0 10px 20px rgba(234,88,12,.25)}

/* Ø£Ø²Ø±Ø§Ø± Ø£Ø¹Ù„Ù‰ */
#topActions{max-width:1400px; margin:10px auto 0; padding:0 16px; display:flex; gap:8px; flex-wrap:wrap}
#topActions .spacer{flex:1}

/* Dashboard */
#dashboardMetrics{max-width:1400px; margin:12px auto 0; padding:0 16px; display:grid; grid-template-columns:repeat(4,minmax(220px,1fr)); gap:12px}
.metric-card{background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)); border:1px solid var(--border); border-radius:16px; padding:14px 16px; backdrop-filter: blur(10px)}
.metric-title{font-size:13px; color:var(--muted); margin-bottom:6px; font-weight:700}
.metric-value{font-size:24px; font-weight:900; color:var(--gold-soft)}
.metric-value.good{color:var(--good)} .metric-value.bad{color:var(--bad)}

/* Main Card & Table */
.wrap{max-width:1400px; margin:12px auto 18px; padding:0 16px}
.card{background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02)); border:1px solid var(--border); border-radius:18px; padding:18px; box-shadow:0 30px 80px rgba(0,0,0,.35); backdrop-filter: blur(12px); overflow-x:auto}
.brand-line{color:#ffde8a; text-align:center; font-weight:800; margin:0 0 10px 0}
#varianceNotice, #varianceNoticeBreakdown{display:none; text-align:center; font-weight:900; font-size:18px; padding:14px; border-radius:12px; border:1px solid transparent}
#varianceNotice.show, #varianceNoticeBreakdown.show{display:block; animation:shake .45s ease}
#zeroVarianceNotice{display:none; text-align:center; background:linear-gradient(135deg,#22c55e,#16a34a); color:#fff; border:2px solid #34d399; font-weight:900; font-size:18px; padding:14px; border-radius:12px}
#zeroVarianceNotice.show{display:block; animation:bounce .45s ease}
table{width:100%; border-collapse:collapse; font-size:16px; color:var(--text)}
th,td{border:1px solid var(--border); padding:10px; text-align:center; vertical-align:middle}
thead th{position:sticky; top:0; z-index:1; background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03)); font-size:17px; font-weight:900}
td[contenteditable]{background:rgba(0,0,0,.25); outline:none; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; border:1px solid rgba(250,204,21,.18); box-shadow: inset 0 0 0 1px rgba(255,255,255,.02), inset 0 0 10px rgba(0,194,255,.12); transition: box-shadow .25s, border-color .25s}
td[contenteditable]:focus{border-color:var(--primary-2); box-shadow: inset 0 0 0 1px rgba(0,194,255,.25), inset 0 0 16px rgba(0,194,255,.22), 0 0 10px rgba(0,194,255,.25)}
.employee-box{background:rgba(255,255,255,.06); border:1px solid var(--border); border-radius:10px; padding:6px 10px; min-width:180px; text-align:right; font-weight:700}
.active-row{outline:2px dashed var(--gold-soft); outline-offset:-2px}
.closed-row{background:rgba(255,255,255,.04); font-style:italic; opacity:.92}
.closed-row td{background:none!important; color:#cbd5e1}
.closed-row.flash{animation:flashGold .8s ease}
@keyframes flashGold{0%{box-shadow:0 0 0 0 rgba(245,197,66,.0)} 50%{box-shadow:0 0 0 8px rgba(245,197,66,.25)} 100%{box-shadow:0 0 0 0 rgba(245,197,66,.0)}}
.closed-row-notes{background:#0f172a}
.closed-row-notes td{border:none!important; text-align:right; padding:6px 10px}

/* Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙ â€” ØªØµØºÙŠØ± ÙˆØªÙ†Ø³ÙŠÙ‚ ÙØ§Ø®Ø± */
.action-cell{position:relative}
.row-delete{background:linear-gradient(135deg,#ef4444,#dc2626); color:#fff; border:none; border-radius:10px; padding:6px 10px; font-weight:800; cursor:pointer; font-size:12px}
.undo-close-btn{background:linear-gradient(135deg,#facc15,#d4af37); color:#1f2937; border:none; border-radius:10px; padding:6px 10px; font-weight:900; cursor:pointer; font-size:12px; box-shadow:0 6px 16px rgba(212,175,55,.25)}
.final-info{
  font-size:11px !important;
  line-height:1.3;
  padding:6px 8px;
  border-radius:10px;
  background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03)); border:1px solid var(--border); color:#eaeaea; border-radius:12px; padding:8px 10px; font-weight:700; font-size:12px; display:inline-block}
.final-info.shimmer{animation: finalShimmer 1.2s ease}
@keyframes finalShimmer{0%{box-shadow:0 0 0 0 rgba(245,197,66,.0)} 50%{box-shadow:0 0 0 8px rgba(245,197,66,.25)} 100%{box-shadow:0 0 0 0 rgba(245,197,66,.0)}}
.delete-closure-btn{
  font-size:11px !important;
  line-height:1.3;
  padding:6px 8px;
  border-radius:10px;
  background:linear-gradient(135deg,#7f1d1d,#b91c1c); color:#fff; border:none; border-radius:10px; padding:6px 10px; font-weight:900; cursor:pointer; font-size:12px; opacity:.9}
.delete-closure-btn:disabled{opacity:.6}

/* Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ + Ø´Ø±ÙŠØ· Ø§Ù„Ù†Ø³Ø¨Ø© */
#closeBtnWrap{text-align:center; padding-top:14px}
#closeBtn{width:100%; max-width:520px; font-size:20px; font-weight:900; position:relative; overflow:hidden}
.progress-bar{position:absolute; left:0; top:0; height:100%; width:0%; background:linear-gradient(90deg, rgba(245,197,66,.25), rgba(0,194,255,.25)); transition:width .05s linear}

/* âœ¨ ØªØ£Ø«ÙŠØ± ØªØ¯Ø±Ø¬ Ù…ØªØ­Ø±Ùƒ ÙØ§Ø®Ø± Ù„Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© */
@keyframes gradientFlow{
  0%{background:linear-gradient(135deg,#f5c542,#eab308)}
  25%{background:linear-gradient(135deg,#eab308,#f59e0b)}
  50%{background:linear-gradient(135deg,#f59e0b,#3ea8ff)}
  75%{background:linear-gradient(135deg,#3ea8ff,#f5c542)}
  100%{background:linear-gradient(135deg,#f5c542,#eab308)}
}
.btn-gradient-anim{ animation:gradientFlow 3s linear infinite; color:#1f2937 !important; box-shadow:0 0 24px rgba(245,197,66,.35), 0 6px 18px rgba(0,0,0,.35) }

/* ğŸ§Š ØªØ£Ø«ÙŠØ± Ø²Ø¬Ø§Ø¬ÙŠ/ØªÙˆÙ‡Ø¬ Ù„Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø±ÙˆØ± */
#closeBtn:hover{
  background:linear-gradient(135deg,var(--gold-soft),var(--gold));
  color:#1f2937 !important;
  border:1px solid rgba(255,255,255,.15);
  
  backdrop-filter: blur(6px);
  box-shadow:0 0 0 2px rgba(255,255,255,.08) inset, 0 8px 26px rgba(245,197,66,.35);
  transform:translateY(-1px);
}

/* Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙˆØ§Ù„Ø­Ø§Ø³Ø¨ØªØ§Ù† */
#notesContainer{margin-top:16px; padding:14px; background:rgba(255,255,255,.04); border:1px solid var(--border); border-radius:12px; display:flex; justify-content:center}
#notesInner{width:50%; min-width:280px}
#notesContainer h3{color:var(--gold-soft); margin:0 0 8px; font-size:16px}
#notesBox{width:100%; min-height:90px; background:rgba(0,0,0,.25); border:1px solid var(--border); color:var(--text); padding:10px; border-radius:10px; resize:vertical; outline:none}

#cashCalcWrapper{display:flex; justify-content:center; gap:16px; margin-top:20px; flex-wrap:wrap}
.calc, .cash-calc{width:338px; max-width:100%; text-align:center; padding:14px; background:linear-gradient(180deg, rgba(0,0,0,.35), rgba(255,255,255,.04)); border:1px solid var(--border); border-radius:18px; backdrop-filter: blur(10px); box-shadow: 0 20px 60px rgba(0,0,0,.35), 0 0 12px rgba(245,197,66,.18); font-size:1.05em}
.cash-calc h3, .calc h3{margin:0 0 8px}
.cash-calc table{width:100%; table-layout:fixed; margin:6px auto}
.cash-calc th,.cash-calc td{padding:8px}
.cash-calc td[contenteditable]{height:30px}
#clearCashBtn{display:block; margin:8px auto 10px}

.calc-display{width:100%; padding:10px; border-radius:10px; border:1px solid var(--border); background:rgba(0,0,0,.35); color:#fff; font-size:20px; text-align:left; direction:ltr}
.calc-grid{display:grid; grid-template-columns:repeat(4,1fr); gap:8px; margin-top:10px}
.calc-grid button{padding:12px 10px; border-radius:12px; border:1px solid var(--border); background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03)); color:#fff; font-weight:800; cursor:pointer}
.calc-grid button.op{background:linear-gradient(135deg,#3ea8ff,#00c2ff); color:#06202b}
.calc-grid button.eq{background:linear-gradient(135deg,#f5c542,#eab308); color:#1f2937}

/* Ø¥Ø´Ø¹Ø§Ø± Ø²Ø¬Ø§Ø¬ÙŠ */
#toast{position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:1200; background:rgba(0,0,0,.25)}
#toast .toast-box{min-width:280px; max-width:80vw; background:linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.04)); border:1px solid rgba(245,197,66,.35); border-radius:18px; padding:14px 16px; text-align:center; color:#fff; box-shadow:0 20px 60px rgba(0,0,0,.45); animation:fadeIn .5s ease forwards}
@keyframes fadeIn{from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:translateY(0)}}
.fadeOut{animation:fadeOut .8s ease forwards}
@keyframes fadeOut{to{opacity:0; transform:translateY(-6px)}}

/* Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© â€” Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ */
@media print{
  @page{ size: A4 landscape; margin: 10mm }
  body{ background:#fff !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  header, #topActions, #dashboardMetrics, .wrap, footer, #login, #toast { display:none !important }
  .print-sheet{ display:block !important }
}
.print-sheet{
  display:none;
  position:fixed; inset:0; z-index:9999; background:#ffffff;
  padding:18mm 12mm 16mm 12mm; color:#111;
}
/* Ø®Ù„ÙÙŠØ© Ù‡Ù†Ø¯Ø³ÙŠØ© Ø°Ù‡Ø¨ÙŠØ© Ø®ÙÙŠÙØ© */
.print-sheet::before{
  content:""; position:absolute; inset:0; z-index:-1; opacity:0.05;
  background:
    repeating-linear-gradient(45deg, #f6d98b 0, #f6d98b 2px, transparent 2px, transparent 18px),
    repeating-linear-gradient(-45deg, #f6d98b 0, #f6d98b 2px, transparent 2px, transparent 18px);
}
/* Ø±Ø£Ø³ ÙˆØªØ°ÙŠÙŠÙ„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
.print-header{ text-align:center; margin-bottom:10px }
.print-header .t1{ color:#9a7b1f; font-weight:800; font-size:20px }
.print-header .t2{ color:#444; font-size:13px; margin-top:4px }
.print-header .t3{ color:#444; font-size:12px; margin-top:2px }
.print-table{ width:100%; border-collapse:collapse; font-size:14px; color:#111; background:#fff }
.print-table th, .print-table td{ border:1px solid #c8a84a; padding:6px 8px; }
.print-table th{ background:#f7f2e1; color:#111; font-weight:800 }
.print-footer{
  text-align:center; color:#9a7b1f; font-size:13px; margin-top:8px
}

/* Ø­Ø±ÙƒØ§Øª */
@keyframes shake{10%,90%{transform:translateX(-1px)} 20%,80%{transform:translateX(2px)} 30%,50%,70%{transform:translateX(-4px)} 40%,60%{transform:translateX(4px)}}
@keyframes bounce{0%,100%{transform:translateY(0)} 50%{transform:translateY(-4px)}}

/* === v5.8 Additions === */
/* Sky glow on entry (subtle, from bottom to top) */
#skyGlow{
  position:fixed; inset:0; pointer-events:none; z-index:2500;
  opacity:0;
  background:
    linear-gradient(180deg, transparent 0%, rgba(150,200,255,0.22) 50%, rgba(150,200,255,0.35) 100%);
  transform:translateY(8px);
  transition:opacity .7s ease, transform .7s ease;
}
#skyGlow.show{ opacity:1; transform:translateY(0) }
#skyGlow.hide{ opacity:0; transform:translateY(-6px); transition:opacity .6s ease, transform .6s ease; }

/* Calculator history box (if not present, harmless) */
.calc-history{
  margin-top:14px;
  max-height:150px;
  overflow-y:auto;
  background:rgba(255,255,255,0.05);
  border:1px solid rgba(255,255,255,0.1);
  border-radius:12px;
  padding:8px;
  text-align:left;
  font-size:14px;
  color:#f1f1f1;
  backdrop-filter:blur(8px);
  box-shadow:inset 0 0 8px rgba(255,255,255,0.05);
}
.calc-history div{ padding:3px 4px; border-bottom:1px solid rgba(255,255,255,0.08); }
.calc-history div:last-child{ border-bottom:none; }

/* Calculator glass buttons */
.calc-grid button{
  background:rgba(255,255,255,0.06);
  border:1px solid rgba(255,255,255,0.1);
  backdrop-filter:blur(6px);
  transition:all .2s ease;
}
.calc-grid button:hover{ transform:translateY(-2px); box-shadow:0 0 10px rgba(255,255,255,0.15); }
.calc-grid button.eq{
  background:linear-gradient(135deg,rgba(245,197,66,0.3),rgba(245,197,66,0.5));
  color:#fff;
  font-weight:900;
  border:1px solid rgba(245,197,66,0.4);
}
.calc-grid button.eq:active{ box-shadow:0 0 15px rgba(245,197,66,0.6); }
.calc-grid button[data-k="C"]{
  background:linear-gradient(135deg,rgba(239,68,68,0.28),rgba(220,38,38,0.45));
  color:#fff;
  font-weight:900;
  border:1px solid rgba(239,68,68,0.4);
}
.calc-grid button[data-k="C"]:hover{ box-shadow:0 0 12px rgba(239,68,68,0.55); }

/* Tiny toast inside calculator (bottom-right) */
.calc-mini-toast{
  position:absolute; right:8px; bottom:8px;
  background:rgba(0,0,0,0.55);
  color:#fff; padding:6px 10px; border-radius:10px;
  font-size:12px; border:1px solid rgba(255,255,255,0.12);
  backdrop-filter:blur(6px);
  animation:toastShake .7s ease;
}
@keyframes toastShake{
  10%, 90% { transform: translate3d(-1px, 0, 0); }
  20%, 80% { transform: translate3d(2px, 0, 0); }
  30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
  40%, 60% { transform: translate3d(4px, 0, 0); }
}

/* Close button state */
#closeBtn{
  transition:box-shadow .25s ease, filter .25s ease, transform .2s ease;
}
#closeBtn.ready{
  cursor:pointer;
  box-shadow:0 0 0 1px rgba(245,197,66,.25) inset, 0 0 18px rgba(245,197,66,.28);
  animation:breathGlow 1.8s ease-in-out infinite;
}
#closeBtn.disabled, #closeBtn:disabled{
  filter:grayscale(.35) brightness(.85);
  cursor:not-allowed !important;
  box-shadow:none;
  animation:none;
}
@keyframes breathGlow{
  0%,100%{ box-shadow:0 0 0 1px rgba(245,197,66,.25) inset, 0 0 10px rgba(245,197,66,.18); }
  50%{ box-shadow:0 0 0 2px rgba(245,197,66,.35) inset, 0 0 22px rgba(245,197,66,.35); }
}

/* Ensure login is interactive if lock CSS exists */
body.locked * { pointer-events:none; opacity:.5; }
body.locked #login, body.locked #login * { pointer-events:auto; opacity:1; z-index:3000; }

/* === v6.1 Calculator History === */
#calcHistoryPanel{
  margin-top:12px;
  background:rgba(255,255,255,0.05);
  border:1px solid rgba(255,255,255,0.1);
  border-radius:12px;
  padding:8px;
  max-height:160px;
  overflow:auto;
  backdrop-filter:blur(8px);
  box-shadow:inset 0 0 8px rgba(255,255,255,0.06);
}
#calcHistoryPanel .h-item{
  padding:6px 8px;
  border-bottom:1px solid rgba(255,255,255,0.08);
  font-size:13px;
  color:#e5e7eb;
  cursor:pointer;
}
#calcHistoryPanel .h-item:last-child{ border-bottom:none; }
@keyframes slideUpFade { from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:translateY(0)} }
#calcHistoryPanel .h-item.new { animation: slideUpFade .35s ease both; }

.calc-mini-toast{
  position:absolute; right:8px; bottom:8px;
  background:rgba(0,0,0,0.55);
  color:#fff; padding:6px 10px; border-radius:10px;
  font-size:12px; border:1px solid rgba(255,255,255,0.12);
  backdrop-filter:blur(6px);
  animation:toastShake .7s ease;
}
@keyframes toastShake{
  10%, 90% { transform: translate3d(-1px, 0, 0); }
  20%, 80% { transform: translate3d(2px, 0, 0); }
  30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
  40%, 60% { transform: translate3d(4px, 0, 0); }
}

/* âœ¨ ØªØ­Ø³ÙŠÙ† ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (ØªÙØ§Ø¹Ù„ - Ø£Ù„ÙˆØ§Ù† - Ø­Ø±ÙƒØ©) */
#login {
  background: radial-gradient(circle at 20% 30%, rgba(0,194,255,.1), transparent 60%),
              radial-gradient(circle at 80% 20%, rgba(245,197,66,.1), transparent 60%),
              linear-gradient(135deg, #081229 0%, #0f172a 60%, #081229 100%);
  animation: moveBg 15s ease-in-out infinite alternate;
}
@keyframes moveBg {
  0% { background-position: 0 0, 0 0, 0 0; }
  100% { background-position: 30px -30px, -30px 30px, 0 0; }
}
.login-card {
  animation: fadeInUp 1.2s ease both;
}
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(30px); }
  to { opacity: 1; transform: translateY(0); }
}
.login-input:focus {
  border-color: var(--gold);
  box-shadow: 0 0 12px rgba(245,197,66,.45), 0 0 20px rgba(0,194,255,.25);
  transform: scale(1.02);
  transition: 0.3s ease;
}
.login-enter {
  transition: all 0.25s ease;
}
.login-enter:hover {
  box-shadow: 0 0 20px rgba(245,197,66,.35);
  transform: translateY(-3px) scale(1.03);
}

.row-fade-in { animation: fadeInRow 0.8s ease both; }
@keyframes fadeInRow { from { opacity:0; transform:scale(0.98); } to { opacity:1; transform:scale(1); } }

<style>

<style>

<style>

<style>

<style>

<style>
/* ğŸŒ¤ï¸ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ Ø§Ù„ÙØ®Ù… â€“ Royal Clarity Gold Edition */
body.light-mode {
  --bg: #f3f4f6;
  --bg2: #f3f4f6;
  --panel: rgba(243,244,246,0.97);
  --panel-strong: rgba(255,255,255,0.98);
  --border: #111827;
  --text: #111827;
  --muted: #1e293b;
  --primary: #1e40af;
  --primary-2: #2563eb;
  --gold: #d4a017;
  --gold-soft: #b5891f;
  --good: #15803d;
  --bad: #dc2626;

  background: var(--bg);
  color: var(--text);
  transition: background 0.6s ease, color 0.6s ease, filter 0.6s ease;
}

/* ğŸ§Š Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ÙˆØ§Ù„Ù„ÙˆØ­Ø§Øª */
body.light-mode .card,
body.light-mode header,
body.light-mode .metric-card {
  background: rgba(243,244,246,0.97);
  color: var(--text);
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  border: 1px solid var(--border);
  backdrop-filter: blur(8px);
}

/* ğŸ“Š Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
body.light-mode table {
  border-collapse: collapse;
  border: 1px solid var(--border);
  background-color: #f3f4f6;
}
body.light-mode thead th {
  background-color: #e5e7eb;
  color: var(--text);
  font-weight: 800;
  border-bottom: 2px solid var(--border);
}
body.light-mode tbody tr:nth-child(even) {
  background-color: #f3f4f6;
}
body.light-mode tbody tr:nth-child(odd) {
  background-color: #e5e7eb;
}
body.light-mode td, body.light-mode th {
  border: 1px solid var(--border);
  color: var(--text);
}
body.light-mode td[contenteditable] {
  background: #f9fafb;
  border: 1px solid var(--border);
  color: #111827;
}
body.light-mode td[contenteditable]:focus {
  border-color: var(--gold);
  box-shadow: 0 0 0 2px rgba(212,160,23,0.3) inset;
}

/* âœ¨ Ø§Ù„Ù†ØµÙˆØµ ÙˆØ§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† */
body.light-mode .brand-line,
body.light-mode .header-left .title {
  color: var(--gold);
}
body.light-mode .header-left .subtitle {
  color: var(--muted);
}
body.light-mode .last-update {
  color: var(--gold);
}

/* ğŸ”˜ Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
body.light-mode .btn-blue {
  background: linear-gradient(135deg, var(--primary-2), var(--primary));
  color: #fff;
  border: 1px solid var(--gold);
  box-shadow: 0 3px 8px rgba(37,99,235,0.3);
}
body.light-mode .btn-blue:hover {
  box-shadow: 0 0 10px rgba(37,99,235,0.4), 0 0 4px rgba(212,160,23,0.3) inset;
}
body.light-mode .btn-gold {
  background: linear-gradient(135deg, var(--gold), var(--gold-soft));
  color: #111827;
  border: 1px solid var(--border);
  box-shadow: 0 4px 10px rgba(212,160,23,0.3);
}
body.light-mode .btn-gold:hover {
  box-shadow: 0 0 8px rgba(212,160,23,0.4), 0 0 4px rgba(17,24,39,0.2) inset;
}
body.light-mode .btn-danger {
  background: #dc2626;
  color: #fff;
  border: 1px solid #7f1d1d;
}

/* ğŸ§® Ø§Ù„Ø­Ø§Ø³Ø¨Ø© ÙˆØ­Ø§Ø³Ø¨Ø© Ø§Ù„ÙƒØ§Ø´ */
body.light-mode .calc,
body.light-mode .cash-calc {
  background: #f3f4f6;
  border: 1px solid var(--border);
  border-radius: 14px;
  color: var(--text);
  box-shadow: 0 4px 14px rgba(0,0,0,0.08);
}
body.light-mode .calc-display {
  background: #e5e7eb;
  color: #111827;
  font-size: 22px;
  font-weight: 700;
  border: 1px solid var(--border);
}
body.light-mode .calc-grid button {
  background: linear-gradient(180deg,#f9fafb,#e5e7eb);
  border: 1px solid var(--border);
  color: #111827;
  font-weight: 700;
}
body.light-mode .calc-grid button.op {
  background: linear-gradient(135deg,#2563eb,#1e40af);
  color: #fff;
  border: 1px solid var(--gold);
}
body.light-mode .calc-grid button.eq {
  background: linear-gradient(135deg,#d4a017,#b5891f);
  color: #fff;
  border: 1px solid var(--gold-soft);
  font-weight: 800;
}
body.light-mode .calc-grid button[data-k="C"] {
  background: #dc2626;
  color: #fff;
  border: 1px solid #7f1d1d;
}

/* ğŸ“‹ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª */
body.light-mode #notesBox {
  background: #f3f4f6;
  color: var(--text);
  border: 1px solid var(--border);
  box-shadow: inset 0 1px 3px rgba(0,0,0,0.08);
}

/* ğŸ“Š Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ù…ØºÙ„Ù‚Ø© */
body.light-mode .closed-row {
  background-color: rgba(243,244,246,0.9);
  color: #111827;
}

/* ğŸ¯ Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù */
body.light-mode td.variance {
  font-weight: 700;
}
body.light-mode td.variance[style*="#22c55e"],
body.light-mode .good { color: var(--good) !important; }
body.light-mode td.variance[style*="#ef4444"],
body.light-mode .bad { color: var(--bad) !important; }
body.light-mode td.variance[style*="#f5c542"],
body.light-mode .neutral { color: var(--gold) !important; }

/* âš™ï¸ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© */
body.light-mode * {
  transition: background 0.4s ease, color 0.4s ease, border-color 0.4s ease;
}
</style>
</style>
</style>
</style>
</style>
</style>

</style>

<meta name="system-signature" content="AYMAN-SAFE-PROTECTED-2025"/>

<!-- Theme system: 6 themes with smooth transitions -->
<style id="themes-styles">
:root {
  transition: background-color 0.6s ease, color 0.6s ease, border-color 0.6s ease, box-shadow 0.6s ease;
}

/* Default (Peach Warm Gradient) as base */
body { --bg: #FFD6C9; --bg2:#FFCC8B; --panel: rgba(255,255,255,0.85); --panel-strong: rgba(255,255,255,0.95);
       --text:#1E1E1E; --muted:#444444; --primary:#FF9F5A; --primary-2:#FFB68A; --gold:#E5A248; --gold-soft:#FFCC8B; --border: rgba(0,0,0,0.08); }

/* Theme classes */
body.theme-peach {
  --bg: #F9F9F9; --bg2:#EFEFEF; --panel: rgba(255,255,255,0.85); --panel-strong: rgba(255,255,255,0.95);
  --text:#1E1E1E; --muted:#444444;
  --primary:#FF9F5A; --primary-2:#FFB68A; --gold:#E5A248; --gold-soft:#FFCC8B;
  --border: rgba(0,0,0,0.08);
}
body.theme-sendpulse {
  --bg:#F5FBFF; --bg2:#D7EDFA; --panel: rgba(255,255,255,0.9); --panel-strong: rgba(255,255,255,1);
  --text:#2C2C2C; --muted:#4A4A4A;
  --primary:#2BA4E0; --primary-2:#1E88C5; --gold:#6AD6E8; --gold-soft:#C7E9F4; --border: rgba(0,0,0,0.1);
}
body.theme-respondio {
  --bg:#F8FBFF; --bg2:#E8F1FF; --panel: rgba(255,255,255,0.92); --panel-strong: rgba(255,255,255,0.98);
  --text:#1E1E1E; --muted:#4C4C4C;
  --primary:#947CFF; --primary-2:#6F5BFF; --gold:#7DBBFF; --gold-soft:#E3F0FF; --border: rgba(0,0,0,0.12);
}
body.theme-neonblue {
  --bg:#0D0D0D; --bg2:#141414; --panel: rgba(255,255,255,0.04); --panel-strong: rgba(255,255,255,0.07);
  --text:#FFFFFF; --muted:#CFCFCF;
  --primary:#0A84FF; --primary-2:#1EA0FF; --gold:#3BC6FF; --gold-soft: rgba(120,200,255,0.65); --border: rgba(255,255,255,0.10);
}
body.theme-g2 {
  --bg:#0E0E0E; --bg2:#1A1A1A; --panel: rgba(255,255,255,0.06); --panel-strong: rgba(255,255,255,0.08);
  --text:#FFFFFF; --muted:#D6D6D6;
  --primary:#FF6A21; --primary-2:#FFB84A; --gold:#D49A3E; --gold-soft:#FFB84A; --border: rgba(255,255,255,0.10);
}
body.theme-javna {
  --bg:#0A0F1A; --bg2:#111827; --panel: rgba(255,255,255,0.06); --panel-strong: rgba(255,255,255,0.10);
  --text:#FFFFFF; --muted:#D6DDE5;
  --primary:#E5007A; --primary-2:#FF4FAE; --gold:#97F5C7; --gold-soft:#E6FFF2; --border: rgba(255,255,255,0.10);
}

/* Apply variables to common places safely (non-destructive) */
body, header, .card, .login-card, .metric-card, table, .calc, .cash-calc, .login-card {
  background: linear-gradient(135deg, var(--bg2) 0%, var(--bg) 100%) !important;
  color: var(--text) !important;
}
header, .card, .metric-card, .calc, .cash-calc {
  background: linear-gradient(180deg, var(--panel), var(--panel-strong)) !important;
  border-color: var(--border) !important;
}

/* Smooth transitions */
* { transition: background-color 0.6s ease, color 0.6s ease, border-color 0.6s ease, box-shadow 0.6s ease !important; }

/* Theme toggle button style (small) */
#themeToggle {
  width:44px; height:44px; display:inline-grid; place-items:center;
  border-radius:10px; background:linear-gradient(135deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
  box-shadow:0 6px 16px rgba(0,0,0,0.25); cursor:pointer; user-select:none;
}
#themeToggle:active { transform: scale(0.96); transition: transform .12s ease; }
</style>


<style id="calc-fixed-colors">
/* Fixed calculator button colors */
.calc button, .cash-calc button, .calc-grid button {
    background-color: #1E90FF !important; /* blue */
    color: #ffffff !important;
    border: none !important;
}
.calc button.op-clear, .cash-calc button.op-clear {
    background-color: #FF6B6B !important; /* red C */
}
.calc button.op-equal, .cash-calc button.op-equal {
    background-color: #F7D97A !important; /* yellow = */
    color: #000 !important;
}
.calc-display, .cash-display {
    background-color: #8E8E8E !important;
    color: #fff !important;
}
</style>


<style id="calc-number-color-fix">
.calc button, .cash-calc button {
    color: #000000 !important; /* numbers always black */
}
/* Keep operator buttons white for contrast if needed */
.calc button.op-clear, .cash-calc button.op-clear {
    color: #ffffff !important;
}
.calc button.op-equal, .cash-calc button.op-equal {
    color: #000000 !important;
}
</style>

</head>
<body class="locked">
<section aria-label="ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„" id="login">
<div class="login-card">
<div class="login-title">Ø­ÙŠØ§Ùƒ Ø§Ù„Ù„Ù‡ ğŸ‘‹</div>
<div class="login-greet" id="greet">ØµØ¨Ø§Ø­ Ø§Ù„Ø®ÙŠØ± ğŸŒ</div>
<div class="login-sub">Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù…Ùƒ</div>
<input class="login-input" id="employeeNameInput" placeholder="Ø§Ø³Ù…Ùƒ" type="text"/>
<button class="btn btn-gold login-enter" disabled="" id="startWorkBtn">Ø¯Ø®ÙˆÙ„</button>
</div>
</section>
<header>
<div class="header-left">
<div class="title">ğŸ› Ù†Ø¸Ø§Ù… ØªÙ‚ÙÙŠÙ„Ø© Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚</div>
<div class="subtitle">Ø¨ÙˆØ§Ø³Ø·Ø© â€“ Ø£ÙŠÙ…Ù† Ø£Ø¨Ùˆ ÙˆØ±Ø¯Ù‡</div>
<div class="phone">ğŸ“ 0570707121</div>
</div>
<div class="user-controls"><button class="btn btn-blue" id="newRowBtn" title="Ø¥Ù†Ø´Ø§Ø¡ ØµÙ Ø¬Ø¯ÙŠØ¯">â• ØµÙ Ø¬Ø¯ÙŠØ¯</button>
<button id="themeToggle" class="btn btn-blue" title="Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ">ğŸŒ™</button>
<button class="btn btn-gold" id="updateVersionBtn" style="display:none;" title="ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥ØµØ¯Ø§Ø±">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥ØµØ¯Ø§Ø±</button>
<button class="btn btn-gold" id="exportBtn" title="ØªØµØ¯ÙŠØ± Excel">ğŸ“¤ ØªØµØ¯ÙŠØ± ØªÙ‚ÙÙŠÙ„Ø§Øª Ø§Ù„Ø´ÙØªØ§Øª (Excel)</button>
<button class="btn btn-blue" id="printBtn" title="Ø·Ø¨Ø§Ø¹Ø© Ù…Ø¨Ø§Ø´Ø±Ø©">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ù…Ø¨Ø§Ø´Ø±Ø© (A4)</button>
<button id="logoutBtn"><span>ğŸ”’ Ø§Ù„Ø­ÙØ¸ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span></button>
<div class="user-pill" id="userName"><span id="userStatus" style="margin-right:6px;">ğŸŸ¢ Ù†Ø´Ø· Ø§Ù„Ø¢Ù†</span> Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ: Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆØ¸Ù</div>
<div class="last-update" id="lastUpdate">ğŸ•“ Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: â€” <span id="serverStatus" style="margin-left:8px;font-weight:800;color:#9fd6ff">ğŸ”„ ØªØ­Ù‚Ù‚ Ø§Ù„Ø®Ø§Ø¯Ù…...</span></div>
</div>
</div>
</header>
<div id="topActions">
<div class="spacer"></div>
<div class="brand-line">Elite Operations â€“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙ†Ø¯Ù‚ÙŠ</div>
</div>
<div id="dashboardMetrics">
<div class="metric-card"><div class="metric-title">ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯ (Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬)</div><div class="metric-value" id="metricTotalRevenue">0</div></div>
<div class="metric-card"><div class="metric-title">ğŸ’µ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒØ§Ø´ Ø§Ù„ÙØ¹Ù„ÙŠ</div><div class="metric-value" id="metricTotalCash">0</div></div>
<div class="metric-card"><div class="metric-title">ğŸ’³ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©</div><div class="metric-value" id="metricTotalNet">0</div></div>
<div class="metric-card"><div class="metric-title">âš–ï¸ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù Ø§Ù„Ø­Ø§Ù„ÙŠ</div><div class="metric-value" id="metricTotalVariance">0</div></div>
</div>
<div class="wrap">
<div class="card">
<div id="varianceNotice"></div>

<!-- START: Advanced Filter Bar Injected -->
<div id="advancedFilter" style="width:calc(100% - 48px);margin:18px 24px;padding:14px;border-radius:12px;
     background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
     backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
     border:1px solid rgba(255,255,255,0.03); display:flex; gap:16px; align-items:center; flex-wrap:wrap;">
  <div style="flex:1; min-width:220px;">
    <label style="font-size:13px;color:#9aa8b8;display:block;margin-bottom:6px">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù</label>
    <select id="fltEmployee" style="width:100%; padding:10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:#e6eef6">
      <option value="">-- ÙƒÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† --</option>
    </select>
  </div>

  <div style="display:flex;gap:8px;align-items:flex-end;">
    <div style="display:flex;flex-direction:column;">
      <label style="font-size:13px;color:#9aa8b8;margin-bottom:6px">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
      <input id="fltFromDate" type="date" style="padding:10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:#e6eef6">
    </div>
    <div style="display:flex;flex-direction:column;">
      <label style="font-size:13px;color:#9aa8b8;margin-bottom:6px">Ù…Ù† ÙˆÙ‚Øª</label>
      <div style="display:flex;gap:6px;">
        <input id="fltFromHour" type="number" min="1" max="12" placeholder="Ø³Ø§Ø¹Ø©" style="width:72px;padding:10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:#e6eef6">
        <input id="fltFromMin" type="number" min="0" max="59" placeholder="Ø¯Ù‚ÙŠÙ‚Ø©" style="width:72px;padding:10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:#e6eef6">
        <select id="fltFromAP" style="padding:10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:#e6eef6">
          <option value="Øµ">Øµ</option><option value="Ù…">Ù…</option>
        </select>
      </div>
    </div>
  </div>

  <div style="display:flex;gap:8px;align-items:flex-end;">
    <div style="display:flex;flex-direction:column;">
      <label style="font-size:13px;color:#9aa8b8;margin-bottom:6px">Ø§Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
      <input id="fltToDate" type="date" style="padding:10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:#e6eef6">
    </div>
    <div style="display:flex;flex-direction:column;">
      <label style="font-size:13px;color:#9aa8b8;margin-bottom:6px">Ø§Ù„Ù‰ ÙˆÙ‚Øª</label>
      <div style="display:flex;gap:6px;">
        <input id="fltToHour" type="number" min="1" max="12" placeholder="Ø³Ø§Ø¹Ø©" style="width:72px;padding:10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:#e6eef6">
        <input id="fltToMin" type="number" min="0" max="59" placeholder="Ø¯Ù‚ÙŠÙ‚Ø©" style="width:72px;padding:10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:#e6eef6">
        <select id="fltToAP" style="padding:10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:#e6eef6">
          <option value="Øµ">Øµ</option><option value="Ù…">Ù…</option>
        </select>
      </div>
    </div>
  </div>

  <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
    <div style="color:#9aa8b8;font-size:13px">Ø¹Ø¯Ø¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬: <span id="fltCount" style="color:#e6b23b;font-weight:800">0</span></div>
    <button id="fltReset" style="background:transparent;border:1px solid rgba(255,255,255,0.06);padding:10px 12px;border-radius:8px;color:#e6eef6;cursor:pointer">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
    <button id="fltApply" style="background:#2aa6d6;border:none;padding:10px 14px;border-radius:8px;color:#07202a;font-weight:800;cursor:pointer">Ø¹Ø±Ø¶</button>
  </div>
</div>
<!-- END: Advanced Filter Bar Injected -->
<table id="mainTable">
<thead>
<tr>
<th>Ù…</th>
<th>Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„Ø®Ø²ÙŠÙ†Ø©</th>
<th>Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙŠÙˆÙ…ÙŠ</th>
<th>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù</th>
<th>Ø§Ù„ØªØ§Ø±ÙŠØ®/ÙˆÙ‚Øª Ø§Ù„Ø¥ØºÙ„Ø§Ù‚</th>
<th>ÙƒØ§Ø´</th>
<th>Visa</th>
<th>MasterCard</th>
<th>American</th>
<th>Ù…Ø¯ÙŠ</th>
<th>ØªØ­ÙˆÙŠÙ„ Ø¨Ù†Ùƒ</th>
<th>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</th>
<th>Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù</th>
<th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
</tr>
</thead>
<tbody id="mainTableBody"></tbody>
<tfoot>
<tr>
<td colspan="6" style="text-align:start">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙŠÙˆÙ…ÙŠ: <span id="totalExpense">0</span></td>
<td colspan="7" style="text-align:end">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù</td>
<td id="totalVariance">0</td>
</tr>
<tr>
<td colspan="14" style="text-align:center; padding-top:14px; border:none">
<div id="varianceSmartNotice" style="display:none; font-weight:900; font-size:17px; padding:10px; border-radius:12px; margin-bottom:10px; text-align:center;"></div>
<div id="closeBtnWrap">
<button class="btn btn-gold" disabled="" id="closeBtn">
<div class="progress-bar" id="closeProgress"></div>
<span id="closeLabel">ğŸ› Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚</span>
</button>
</div>
</td>
</tr>
</tfoot>
</table>
<div id="notesContainer">
<div id="notesInner">
<h3>ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª ØªÙ‚ÙÙŠÙ„ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚</h3>
<textarea id="notesBox" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ Ù‡Ù†Ø§ (Ù…Ø«Ù„: Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ø§Ù†Ø­Ø±Ø§ÙØŒ Ø¥Ù„Ø®.)"></textarea>
</div>
</div>
<div id="cashCalcWrapper">
<div class="calc" id="basicCalc">
<h3>Ø¢Ù„Ø© Ø­Ø§Ø³Ø¨Ø©</h3>
<input class="calc-display" id="calcDisplay" readonly="" type="text" value=""/>
<div class="calc-grid">
<button data-k="7">7</button>
<button data-k="8">8</button>
<button data-k="9">9</button>
<button class="op" data-k="/">Ã·</button>
<button data-k="4">4</button>
<button data-k="5">5</button>
<button data-k="6">6</button>
<button class="op" data-k="*">Ã—</button>
<button data-k="1">1</button>
<button data-k="2">2</button>
<button data-k="3">3</button>
<button class="op" data-k="-">âˆ’</button>
<button data-k="0">0</button>
<button data-k=".">.</button>
<button data-k="C">C</button>
<button class="op" data-k="+">+</button>
<button data-k="âŒ«">âŒ«</button>
<button class="eq" data-k="=" style="grid-column: span 3">=</button>
</div>
</div>
<div class="cash-calc">
<h3>Ø­Ø§Ø³Ø¨Ø© Ø§Ù„ÙƒØ§Ø´</h3>
<button class="btn btn-blue" id="clearCashBtn">ğŸ”„ Ø¨Ø¯Ø¡ Ø­Ø§Ø³Ø¨Ø© Ø§Ù„ÙƒØ§Ø´ Ù…Ù† Ø¬Ø¯ÙŠØ¯</button>
<table id="cashCalc">
<thead><tr><th>Ø§Ù„Ø¹Ø¯Ø¯</th><th>Ø§Ù„ÙØ¦Ø©</th></tr></thead>
<tbody>
<tr><td contenteditable=""></td><td>500</td></tr>
<tr><td contenteditable=""></td><td>200</td></tr>
<tr><td contenteditable=""></td><td>100</td></tr>
<tr><td contenteditable=""></td><td>50</td></tr>
<tr><td contenteditable=""></td><td>20</td></tr>
<tr><td contenteditable=""></td><td>10</td></tr>
<tr><td contenteditable=""></td><td>5</td></tr>
<tr><td contenteditable=""></td><td>1V</td></tr>
</tbody>
<tfoot><tr><td id="cashTotal">0</td><td>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</td></tr></tfoot>
</table>
</div>
</div>
</div>
</div>
<footer>
  Ø£ÙŠÙ…Ù† Ø£Ø¨Ùˆ ÙˆØ±Ø¯Ù‡ â€“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ | Operations Management
  <br/>ğŸ•“ <span id="dateNow"></span> | Ø§Ù„Ø¥ØµØ¯Ø§Ø± 1.1 â€“ 2025-11-12
</footer>
<div id="toast"><div class="toast-box" id="toastBox">ØªÙ…</div></div>
<section aria-hidden="true" class="print-sheet" id="printSheet">
<div class="print-header">
<div class="t1">Elite Operations â€“ ØªÙ‚Ø±ÙŠØ± ØªÙ‚ÙÙŠÙ„Ø§Øª Ø§Ù„Ø´ÙØªØ§Øª â€“ <span id="printDate"></span></div>
<div class="t2">Ù†Ø¸Ø§Ù… ØªÙ‚ÙÙŠÙ„Ø© Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ â€“ Ø£ÙŠÙ…Ù† Ø£Ø¨Ùˆ ÙˆØ±Ø¯Ù‡</div>
<div class="t3">ğŸ“ 0570707121</div>
</div>
<table class="print-table" id="printTable">
<thead>
<tr>
<th>Ù…</th><th>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®/ÙˆÙ‚Øª Ø§Ù„Ø¥ØºÙ„Ø§Ù‚</th>
<th>ÙƒØ§Ø´</th><th>Visa</th><th>MasterCard</th><th>American</th><th>Ù…Ø¯ÙŠ</th>
<th>ØªØ­ÙˆÙŠÙ„ Ø¨Ù†Ùƒ</th><th>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</th><th>Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙŠÙˆÙ…ÙŠ</th><th>Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù</th>
</tr>
</thead>
<tbody id="printTbody"></tbody>
</table>
<div class="print-footer" id="printFooter"></div>
</section>
<audio id="sndIntro" preload="auto" src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAACAAACaAAAAP8AAAA="></audio>
<audio id="sndCreate" preload="auto" src="data:audio/wav;base64,UklGRgAAAABXQVZFZm10IAAAAAABAAEAQB8AAEAfAAACAAACAAAAAP8AAAA="></audio>
<audio id="sndDelete" preload="auto" src="data:audio/wav;base64,UklGRgAAAABXQVZFZm10IAAAAAABAAEAQB8AAEAfAAACAAACAAAAAP8AAAA="></audio>
<audio id="sndSave" preload="auto" src="data:audio/wav;base64,UklGRgAAAABXQVZFZm10IAAAAAABAAEAQB8AAEAfAAACAAACAAAAAP8AAAA="></audio>
<audio id="sndClose" preload="auto" src="data:audio/wav;base64,UklGRgAAAABXQVZFZm10IAAAAAABAAEAQB8AAEAfAAACAAACAAAAAP8AAAA="></audio>
<audio id="sndToast" preload="auto" src="data:audio/wav;base64,UklGRgAAAABXQVZFZm10IAAAAAABAAEAQB8AAEAfAAACAAACAAAAAP8AAAA="></audio>
<audio id="sndLogout" preload="auto" src="data:audio/wav;base64,UklGRgAAAABXQVZFZm10IAAAAAABAAEAQB8AAEAfAAACAAACAAAAAP8AAAA="></audio>
<script>
/* Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø© */
const STORE_KEY='cashRegisterData';
const UNDO_CLOSURE_TIME=30;       // 30 Ø«Ø§Ù†ÙŠØ©
const DELETE_CLOSURE_TIME=43200;  // 12 Ø³Ø§Ø¹Ø©
let storedEmployeeName="ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
let currentRecordRow=null;
let autosaveTimeout=null;
let undoTimers={}, deleteTimers={};
const mainBody=document.getElementById('mainTableBody');

/* Ø£Ø¯ÙˆØ§Øª */
function toNum(v){return parseFloat(String(v).replace(/[^\d.-]/g,''))||0;}
function fmtEN(n){return new Intl.NumberFormat('en-US').format(n);}
function play(id){try{const a=document.getElementById(id); a.currentTime=0; a.play();}catch{}}

/* Ø¥Ø´Ø¹Ø§Ø± Ø²Ø¬Ø§Ø¬ÙŠ */
function showToast(message){
  const toast=document.getElementById('toast');
  const box=document.getElementById('toastBox');
  box.textContent=message;
  toast.style.display='flex';
  play('sndToast');
  setTimeout(()=>{box.classList.add('fadeOut');}, 2200);
  setTimeout(()=>{
    toast.style.display='none';
    box.classList.remove('fadeOut');
  }, 3000);
}

/* ÙˆØ§Ø¬Ù‡Ø© Ø£Ø¹Ù„Ù‰ */
function setUserUI(){
  document.getElementById("userName").textContent="Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ: "+(storedEmployeeName==="ØºÙŠØ± Ù…Ø­Ø¯Ø¯"?"Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆØ¸Ù":storedEmployeeName);
  document.getElementById("lastUpdate").textContent="ğŸ•“ Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: "+new Date().toLocaleString('ar-EG');
  updateCloseButtonState();
}

/* âœ… Ø±Ø¨Ø· Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ØºÙ„Ù‚ ÙÙŠ Ø§Ù„ØµÙØ­Ø© (Ø¨Ø¯ÙˆÙ† Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ LocalStorage) */
function calculateMetricsFromDOM(){
  const rows=[...document.querySelectorAll('#mainTableBody tr.closed-row')];
  let totalRevenue=0,totalCash=0,totalNet=0,totalVariance=0;
  rows.forEach(tr=>{
    const t=tr.querySelectorAll('td');
    totalCash += toNum(t[5].innerText);
    totalNet  += toNum(t[6].innerText)+toNum(t[7].innerText)+toNum(t[8].innerText)+toNum(t[9].innerText);
    totalRevenue += toNum(t[11].innerText);
    totalVariance+= toNum(t[12].innerText);
  });
  document.getElementById('metricTotalRevenue').textContent = fmtEN(totalRevenue);
  document.getElementById('metricTotalCash').textContent    = fmtEN(totalCash);
  document.getElementById('metricTotalNet').textContent     = fmtEN(totalNet);
  const v=document.getElementById('metricTotalVariance');
  v.textContent = fmtEN(totalVariance);
  v.classList.remove('good','bad');
  if(totalVariance>0)v.classList.add('good');
  else if(totalVariance<0)v.classList.add('bad');
}

/* Ø­Ø³Ø§Ø¨Ø§Øª */
function sumDailyExpense(){
  let total=0; document.querySelectorAll('#mainTableBody tr:not(.closed-row)').forEach(tr=> total+=toNum(tr.cells[2].innerText));
  document.getElementById('totalExpense').textContent=fmtEN(total); return total;
}
function recalc(){

  const rows=document.querySelectorAll('#mainTableBody tr:not(.closed-row)');
  let totalVar=0;
  rows.forEach(tr=>{
    const t=tr.querySelectorAll('td'); if(t.length<14) return;
    const Expense=toNum(t[2].innerText), Cash=toNum(t[5].innerText);
    const Net=toNum(t[6].innerText)+toNum(t[7].innerText)+toNum(t[8].innerText)+toNum(t[9].innerText);
    const Bank=toNum(t[10].innerText), Program=toNum(t[11].innerText);
    const variance=(Cash+Net+Bank+Expense)-Program;
    const cell=t[12]; cell.textContent=fmtEN(variance); cell.style.color=variance>0?"#22c55e":variance<0?"#ef4444":"#f5c542";
    totalVar+=variance;
  });
  sumDailyExpense();
  document.getElementById('totalVariance').textContent=fmtEN(totalVar);
  updateCloseButtonState();
  // ğŸ”” ØªÙ†Ø¨ÙŠÙ‡ Ø°ÙƒÙŠ Ù„Ù„Ø§Ù†Ø­Ø±Ø§Ù
  const notice=document.getElementById('varianceSmartNotice');

  // ğŸŸ¡ Ù…Ù†Ø·Ù‚ Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø°ÙƒÙŠØ©
  const glassBase = 'linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.03))';
  const glassBorder = '1px solid rgba(255,255,255,0.12)';

  const activeRow=document.querySelector('#mainTableBody tr.active-row');
  if(!activeRow) return;
  const emp=activeRow.querySelector('.employee-box')?.innerText||'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
  const variance=toNum(activeRow.querySelectorAll('td')[12].innerText);
  const today=new Date().toLocaleDateString('ar-EG');
  if(Math.abs(variance)<=1){
    notice.style.background='linear-gradient(135deg, rgba(245,197,66,0.45), rgba(234,179,8,0.3))';
    notice.style.backdropFilter='blur(10px)';
    notice.style.border='1px solid rgba(245,197,66,0.25)';
    notice.style.boxShadow='0 0 20px rgba(245,197,66,0.25)';
    notice.style.animation='pulseNeutral 1.6s ease-in-out infinite';
    notice.style.display='block';
    notice.style.background='linear-gradient(135deg, rgba(34,197,94,0.45), rgba(22,163,74,0.3))';
    notice.style.backdropFilter='blur(10px)';
    notice.style.border='1px solid rgba(34,197,94,0.25)';
    notice.style.boxShadow='0 0 20px rgba(34,197,94,0.25)';
    notice.style.animation='pulseGood 1.6s ease-in-out infinite';
    notice.style.color='#fff';
    notice.textContent=`ğŸ‰ Ù…Ù…ØªØ§Ø² ${emp}! ØªØ·Ø§Ø¨Ù‚ ØªØ§Ù… Ù…Ø¹ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ (${today}) ğŸŒŸ`;
  } else {
    notice.style.display='block';
    notice.style.background = variance > 0 ? "linear-gradient(135deg, rgba(34,197,94,0.45), rgba(22,163,74,0.3))" : "linear-gradient(135deg, rgba(239,68,68,0.45), rgba(185,28,28,0.3))";
    notice.style.backdropFilter='blur(10px)';
    notice.style.border='1px solid rgba(239,68,68,0.25)';
    notice.style.boxShadow='0 0 20px rgba(239,68,68,0.25)';
    notice.style.animation='pulseBad 1.6s ease-in-out infinite';
    notice.style.color='#fff';
    notice.textContent=`âš ï¸ ÙŠÙˆØ¬Ø¯ Ø§Ù†Ø­Ø±Ø§Ù Ø¨Ø³ÙŠØ· Ø¨Ù‚ÙŠÙ…Ø© ${variance>0?'+':''}${variance.toFixed(2)} Ø±ÙŠØ§Ù„ØŒ Ù†Ø£Ù…Ù„ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© â€” Ù…Ø§ ÙŠØºÙ„Ø· Ø¥Ù„Ø§ Ø§Ù„Ø´Ø§Ø·Ø±.`;
  }

  calculateMetricsFromDOM(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ ÙÙˆØ±Ù‹Ø§
}
function recalcCash(){
  let total=0; document.querySelectorAll('#cashCalc tbody tr').forEach(tr=>{const c=toNum(tr.cells[0].innerText), v=toNum(tr.cells[1].innerText); total+=c*v;});
  document.getElementById('cashTotal').textContent=fmtEN(total);
  saveActiveRecordData();
}

/* Ø§Ù„Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© */
(function initBasicCalc(){
  const disp=document.getElementById('calcDisplay');
  const grid=document.querySelector('#basicCalc .calc-grid');
  function append(k){
  const histBox=document.getElementById('calcHistory');
    if(k==='C'){
      disp.value='';
      if(histBox){ histBox.innerHTML=''; try{ localStorage.setItem('calcHistoryData', JSON.stringify([])); }catch(_){}}
      calcMiniToast('ğŸ§¹ ØªÙ… Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª');
      return;
    }
    if(k==='âŒ«'){disp.value=disp.value.slice(0,-1); return;}
    if(k==='='){
      const histBox=document.getElementById('calcHistory');
      try{ const res=Function('return '+disp.value.replace(/Ã·/g,'/').replace(/Ã—/g,'*'))(); disp.value=(res??'')+''; }
      catch{ disp.value=''; }
      return;
    }
    disp.value+=k;
  }
  grid.addEventListener('click',e=>{
    const k=e.target.getAttribute('data-k'); if(!k) return; append(k);
  });
  document.addEventListener('keydown',e=>{
    if (document.activeElement && document.activeElement.isContentEditable) return; // ğŸ”’ ignore typing in table/cash cells
    if (['INPUT','TEXTAREA'].includes(document.activeElement.tagName)) return; // ignore if inside other input
    
    const allowed='0123456789.+-*/()';
    if(allowed.includes(e.key)){ append(e.key); }
    else if(e.key==='Enter'){ append('='); e.preventDefault(); }
    else if(e.key==='Backspace'){ append('âŒ«'); }
    else if(e.key==='Escape'){ append('C'); }
  });
})();

/* Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„ØµÙ Ø§Ù„Ù†Ø´Ø· */
function getCashCalcData(){return [...document.querySelectorAll('#cashCalc tbody tr')].map(tr=>({count:tr.cells[0].innerText.trim(),denom:tr.cells[1].innerText.trim()}));}
function setCashCalcData(data){if(!Array.isArray(data))return; const trs=document.querySelectorAll('#cashCalc tbody tr'); data.slice(0,trs.length).forEach((r,i)=> trs[i].cells[0].textContent=(r.count||'')); recalcCash();}
function saveActiveRecordData(){
  clearTimeout(autosaveTimeout);
  autosaveTimeout=setTimeout(()=>{
    if(!currentRecordRow || currentRecordRow.classList.contains('closed-row')) return;
    const t=currentRecordRow.querySelectorAll('td'); const employeeBox=currentRecordRow.querySelector('.employee-box');
    const active={ treasuryReserve: toNum(t[1].innerText)||'', expense:toNum(t[2].innerText)||'', employee:employeeBox.textContent.trim(), cash:toNum(t[5].innerText)||'', visa:toNum(t[6].innerText)||'', masterCard:toNum(t[7].innerText)||'', american:toNum(t[8].innerText)||'', mada:toNum(t[9].innerText)||'', bankTransfer:toNum(t[10].innerText)||'', programRevenue:toNum(t[11].innerText)||'', cashCalc:getCashCalcData(), notes:document.getElementById('notesBox').value, lastSaveTime:new Date().toISOString() };
    localStorage.setItem('activeRecordAutosave', JSON.stringify(active));
    document.getElementById('lastUpdate').textContent="ğŸ’¾ ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ";
    play('sndSave');
  }, 900);
}

/* Ø±Ø¨Ø· Ø§Ù„ØªØ­Ø±ÙŠØ± */
function bindEditable(scope=document){
  scope.querySelectorAll('[contenteditable]').forEach(el=>{
    el.addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault(); el.blur();}});
    el.addEventListener('input',()=>{recalc(); saveActiveRecordData();});
  });
  document.querySelectorAll('#cashCalc td[contenteditable]').forEach(el=>{
    el.addEventListener('input',()=>{recalcCash(); saveActiveRecordData();});
  });
  document.getElementById('notesBox').addEventListener('input', saveActiveRecordData);
}
function updateRowNumbers(){
  const rows=[...document.querySelectorAll('#mainTableBody tr:not(.closed-row-notes)')];
  rows.forEach((row,idx)=>{row.dataset.recordId=(idx+1); row.cells[0].textContent=(idx+1);});
}

/* Ø¥Ù†Ø´Ø§Ø¡ ØµÙ Ø¬Ø¯ÙŠØ¯ */

function injectDeleteButtonInto(row){
  const mainBody = document.getElementById('mainTableBody');
  const rows = [...mainBody.querySelectorAll('tr')];
  const closedRows = rows.filter(r => r.classList.contains('closed-row'));
  const firstActiveAfterClosed = rows.find(r => !r.classList.contains('closed-row'));

  const delBtn=document.createElement('button');
  delBtn.className='row-delete';
  delBtn.textContent='ğŸ—‘ Ø­Ø°Ù Ø§Ù„ØµÙ Ø§Ù„Ù†Ø´Ø·';
  delBtn.addEventListener('click', ()=>{
    if(!row.classList.contains('active-row')) return;
    if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„ØµÙ Ø§Ù„Ù†Ø´Ø· ØºÙŠØ± Ø§Ù„Ù…ØºÙ„Ù‚ØŸ')){
      row.remove(); updateRowNumbers(); recalc(); play('sndDelete');
      ensureActiveRow(); showToast('ğŸ—‘ ØªÙ… Ø­Ø°Ù Ø§Ù„ØµÙ Ø¨Ù†Ø¬Ø§Ø­');
    }
  });

  row.cells[13].innerHTML='';

  // âœ… Ù„Ø§ ØªØ¶Ù Ø§Ù„Ø²Ø± Ù„Ù„ØµÙ Ø§Ù„Ù†Ø´Ø· Ø§Ù„Ø£ÙˆÙ„ Ø¨Ø¹Ø¯ Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ù…ØºÙ„Ù‚Ø©
  if (row === firstActiveAfterClosed) {
    return; // Ù„Ø§ ÙŠØ¸Ù‡Ø± Ø²Ø± Ø§Ù„Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§
  }

  row.cells[13].appendChild(delBtn);
}

function createNewRow(rowData=null, autoSaved=null){
  const lastId=JSON.parse(localStorage.getItem(STORE_KEY)||'[]').reduce((m,r)=>Math.max(m,r.id),0);
  const newId=rowData?.id ?? (lastId+1);
  const tr=document.createElement('tr'); tr.dataset.recordId=newId;

  const d=rowData||autoSaved||{}; const isClosed=!!rowData?.closeTime;
  const employeeName = rowData ? rowData.employee : storedEmployeeName;

  tr.innerHTML=`
    <td></td>
    <td contenteditable>${d.treasuryReserve??''}</td>
    <td contenteditable>${d.expense??''}</td>
    <td><div class="employee-box" contenteditable="false">${employeeName}</div></td>
    <td>${isClosed ? (rowData.closeTime) : ''}</td>
    <td contenteditable>${d.cash??''}</td>
    <td contenteditable>${d.visa??''}</td>
    <td contenteditable>${d.masterCard??''}</td>
    <td contenteditable>${d.american??''}</td>
    <td contenteditable>${d.mada??''}</td>
    <td contenteditable>${d.bankTransfer??''}</td>
    <td contenteditable>${d.programRevenue??''}</td>
    <td class="variance">${fmtEN(d.variance??0)}</td>
    <td class="action-cell"></td>
  `;
  mainBody.appendChild(tr);
  tr.classList.add('row-fade-in');

  if(isClosed){
    tr.classList.add('closed-row');
  }else{
    tr.classList.add('active-row');
    bindEditable(tr);
    injectDeleteButtonInto(tr);
    currentRecordRow=tr;
    play('sndCreate');
  }

  if(autoSaved && !isClosed){
    setCashCalcData(autoSaved.cashCalc);
    document.getElementById('notesBox').value=autoSaved.notes||'';
  }

  updateRowNumbers();
  recalc();
  return tr;
}

/* Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ */
function saveRecord(row, closeTime){
  const t=row.querySelectorAll('td'); const employeeBox=row.querySelector('.employee-box'); const id=parseInt(row.dataset.recordId);
  const record={ id, treasuryReserve:toNum(t[1].innerText), expense:toNum(t[2].innerText), employee:employeeBox.textContent.trim(), closeTime,
    cash:toNum(t[5].innerText), visa:toNum(t[6].innerText), masterCard:toNum(t[7].innerText), american:toNum(t[8].innerText), mada:toNum(t[9].innerText),
    bankTransfer:toNum(t[10].innerText), programRevenue:toNum(t[11].innerText), variance:toNum(t[12].innerText),
    undoTimer:UNDO_CLOSURE_TIME, deleteTimer:DELETE_CLOSURE_TIME, notes:document.getElementById('notesBox').value||'' };
  let records=JSON.parse(localStorage.getItem(STORE_KEY)||'[]') || [];
  const idx=records.findIndex(r=>r.id===id); if(idx>-1) records[idx]=record; else records.push(record);
  localStorage.setItem(STORE_KEY, JSON.stringify(records));
  return record;
}

/* Ø¹Ø¯Ù‘ 30 Ø«Ø§Ù†ÙŠØ© Ø«Ù… 12 Ø³Ø§Ø¹Ø© */
function startUndoCountdown(row, recordId, ownerName){
  const cell=row.cells[13]; cell.innerHTML='';
  const btn=document.createElement('button'); btn.className='undo-close-btn'; btn.innerHTML=`â†©ï¸ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¥Ù‚ÙØ§Ù„ (<span class="sec">${UNDO_CLOSURE_TIME}</span>s)`;
  cell.appendChild(btn);
  let timeLeft=UNDO_CLOSURE_TIME;
  undoTimers[recordId] && clearInterval(undoTimers[recordId]);
  const timer=setInterval(()=>{
    timeLeft--; const s=btn.querySelector('.sec'); if(s) s.textContent=timeLeft;
    if(timeLeft<=0){
      clearInterval(timer); delete undoTimers[recordId]; btn.remove();
      showFinalClosureInfo(row, recordId);
      play('sndToast');
      ensureActiveRow();
      updateCloseButtonState();
    }
  },1000);
  undoTimers[recordId]=timer;
  btn.addEventListener('click', ()=>{
    if(timeLeft>0 && storedEmployeeName.toLowerCase()===ownerName.toLowerCase()){
      clearInterval(timer); delete undoTimers[recordId];
      undoClose(row, recordId);
    }
  });
}
function showFinalClosureInfo(row, recordId){
  const cell=row.cells[13]; cell.innerHTML='';
  const info=document.createElement('div'); info.className='final-info shimmer';
  info.innerHTML='ğŸ”’ ØªÙ… Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„Ø´ÙØª<br><span style="font-size:12px;opacity:.9">ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø­Ø°Ù Ø¨Ø¹Ø¯ 12 Ø³Ø§Ø¹Ø©</span>';
  cell.appendChild(info);
  startDeleteCountdown(row, recordId);
}
function startDeleteCountdown(row, recordId){
  if (storedEmployeeName.toLowerCase() === 'ayman777adam') {
    const cell=row.cells[13];
    const btn=document.createElement('button');
    btn.className='delete-closure-btn';
    btn.textContent='ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„ØªÙ‚ÙÙŠÙ„Ø© Ø§Ù„Ø¢Ù† (ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø£Ø¯Ù…Ù†)';
    btn.onclick=()=>{ if(confirm('Ø­Ø°Ù Ø§Ù„ØªÙ‚ÙÙŠÙ„Ø© Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ Ø¨ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø£Ø¯Ù…Ù†ØŸ')) deleteRecord(recordId); };
    cell.appendChild(document.createElement('br'));
    cell.appendChild(btn);
    return;
  }

  const cell=row.cells[13];
  const btn=document.createElement('button'); btn.className='delete-closure-btn'; btn.disabled=true;
  btn.innerHTML=`ğŸ—“ï¸ Ø­Ø°Ù Ø§Ù„ØªÙ‚ÙÙŠÙ„Ø© (<span class="hours">12</span>h <span class="minutes">00</span>m <span class="seconds">00</span>s)`;
  cell.appendChild(document.createElement('br')); cell.appendChild(btn);
  let timeLeft=DELETE_CLOSURE_TIME;
  deleteTimers[recordId] && clearInterval(deleteTimers[recordId]);
  const timer=setInterval(()=>{
    timeLeft--; const h=Math.floor(timeLeft/3600), m=Math.floor((timeLeft%3600)/60), s=timeLeft%60;
    btn.querySelector('.hours').textContent=h; btn.querySelector('.minutes').textContent=m.toString().padStart(2,'0'); btn.querySelector('.seconds').textContent=s.toString().padStart(2,'0');
    if(timeLeft<=0){ clearInterval(timer); delete deleteTimers[recordId]; btn.disabled=false; btn.textContent='ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„ØªÙ‚ÙÙŠÙ„Ø© Ø§Ù„Ø¢Ù†';
      btn.onclick=()=>{ if(confirm(`Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ø±Ù‚Ù… ${recordId} Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ØŸ`)) deleteRecord(recordId); }; }
  },1000);
  deleteTimers[recordId]=timer;
}
function undoClose(row, recordId){
  let records=JSON.parse(localStorage.getItem(STORE_KEY)||'[]') || [];
  const idx=records.findIndex(r=>r.id==recordId); let last=null;
  if(idx>-1){ last=records.splice(idx,1)[0]; localStorage.setItem(STORE_KEY, JSON.stringify(records)); }
  const newActive=document.querySelector('#mainTableBody tr.active-row'); if(newActive) newActive.remove();
  row.classList.remove('closed-row'); row.classList.add('active-row');
  row.querySelectorAll('td:not(:first-child):not(:nth-child(4)):not(:nth-child(13))').forEach(td=>td.setAttribute('contenteditable','true'));
  row.cells[4].innerHTML=''; row.cells[13].innerHTML='';
  const employeeBox=row.querySelector('.employee-box'); if(employeeBox) employeeBox.setAttribute('contenteditable','false');
  injectDeleteButtonInto(row);
  currentRecordRow=row;
  if(last){ setCashCalcData(last.cashCalc); document.getElementById('notesBox').value=last.notes||''; }
  bindEditable(row); recalc(); updateCloseButtonState();
}

/* Ø­Ø°Ù Ø³Ø¬Ù„ */
function deleteRecord(recordId){
  let records=JSON.parse(localStorage.getItem(STORE_KEY)||'[]') || [];
  const idx=records.findIndex(r=>r.id===recordId);
  if(idx>-1){ records.splice(idx,1); localStorage.setItem(STORE_KEY, JSON.stringify(records)); }
  const row=[...document.querySelectorAll('#mainTableBody tr')].find(r=>parseInt(r.dataset.recordId)===recordId);
  if(row){ const notesRow=document.querySelector(`#mainTableBody tr[data-record-id="${recordId}-notes"]`); if(notesRow) notesRow.remove(); row.remove(); }
  updateRowNumbers(); recalc(); play('sndDelete'); showToast('ğŸ—‘ ØªÙ… Ø­Ø°Ù Ø§Ù„ØµÙ Ø¨Ù†Ø¬Ø§Ø­');
  ensureActiveRow();
}

/* Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ù…Ø¹ Ù†Ø³Ø¨Ø© ÙˆØªØºÙŠÙŠØ± Ù†Øµ Ø¨Ø¹Ø¯ 100Ùª + âœ¨ ØªØ¯Ø±Ø¬ Ù…ØªØ­Ø±Ùƒ ÙØ§Ø®Ø± */
function updateCloseButtonState(){
  const btn=document.getElementById('closeBtn');
  const label=document.getElementById('closeLabel');
  label.textContent='ğŸ› Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚';
  if(!currentRecordRow || currentRecordRow.classList.contains('closed-row') || btn.classList.contains('loading')){btn.disabled=true; return;}
  const employeeBox=currentRecordRow.querySelector('.employee-box');
  const revenueCell=currentRecordRow.cells[11];
  const actionCell=currentRecordRow.cells[13];
  const isUndoActive=actionCell.querySelector('.undo-close-btn');
  if(isUndoActive){btn.disabled=true; return;}
  const sameUser = employeeBox && employeeBox.textContent.trim().toLowerCase()===storedEmployeeName.toLowerCase();
  const revenueOk = toNum(revenueCell.textContent)>0;
  btn.disabled = !(sameUser && revenueOk);
}
function closeActiveRow(){

  const activeRows=document.querySelectorAll('#mainTableBody tr.active-row');
  if(activeRows.length===0){ ensureActiveRow(); return; }
  const row=activeRows[activeRows.length-1];
  if(row.classList.contains('closed-row')) return;

  const programRevenue=toNum(row.cells[11].textContent);
  if(programRevenue<=0){ showToast('âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬'); return; }

  const btn=document.getElementById('closeBtn');
  const bar=document.getElementById('closeProgress');
  const label=document.getElementById('closeLabel');

  btn.disabled=true; btn.classList.add('loading');
  btn.classList.add('btn-gradient-anim'); // ØªØ¯Ø±Ø¬ ÙØ§Ø®Ø± Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚

  let p=0; bar.style.width='0%'; label.textContent=`ğŸ› Ø¬Ø§Ø±ÙŠ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚â€¦ 0Ùª`;
  const int=setInterval(()=>{
    p=Math.min(100, p+3.333);
    bar.style.width=p.toFixed(0)+'%';
    label.textContent=`ğŸ› Ø¬Ø§Ø±ÙŠ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚â€¦ ${p.toFixed(0)}Ùª`;
    if(p>=100){
      clearInterval(int);
      btn.classList.remove('loading');

      // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙ ÙØ¹Ù„ÙŠÙ‹Ø§
      row.classList.remove('active-row'); row.classList.add('closed-row','flash');
      row.querySelectorAll('[contenteditable]').forEach(td=> td.removeAttribute('contenteditable'));
      row.cells[4].innerHTML=new Date().toLocaleString('ar-EG');

      const record=saveRecord(row, row.cells[4].innerText);

      // ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ ÙÙˆØ±Ù‹Ø§ Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„
      calculateMetricsFromDOM();

      // ØµÙ Ù…Ù„Ø§Ø­Ø¸Ø§Øª ØªØ­Øª Ø§Ù„ØµÙ Ø¥Ø°Ø§ ÙˆÙØ¬Ø¯Øª
      const notes=document.getElementById('notesBox').value;
      if(notes.trim()){
        const notesRow=document.createElement('tr'); notesRow.classList.add('closed-row-notes'); notesRow.dataset.recordId=record.id+'-notes';
        notesRow.innerHTML=`<td colspan="14"><span style="color:var(--gold-soft); font-weight:800">Ù…Ù„Ø§Ø­Ø¸Ø©:</span> ${notes.trim()}</td>`;
        row.insertAdjacentElement('afterend', notesRow);
      }

      // ØªØµÙÙŠØ± Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙˆØ§Ù„Ø­Ø§Ø³Ø¨Ø©
      document.getElementById('notesBox').value='';
      // ğŸ” ØªØµÙÙŠØ± Ø§Ù„Ø­Ø§Ø³Ø¨Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚
      document.getElementById('calcDisplay').value = '';
      const calcHist = document.getElementById('calcHistory');
      if (calcHist) calcHist.innerHTML = '';
      localStorage.removeItem('calcHistoryData');
        
      document.querySelectorAll('#cashCalc td[contenteditable]').forEach(td=> td.textContent=''); recalcCash();
      localStorage.removeItem('activeRecordAutosave');

      // Ø¨Ø¯Ø¡ Ø¹Ø¯Ù‘ 30 Ø«Ø§Ù†ÙŠØ© Ù„Ù„ØªØ±Ø§Ø¬Ø¹ Ø«Ù… Ø¹Ø±Ø¶ Ù†Øµ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
      startUndoCountdown(row, record.id, record.employee);

      // Ø¥Ø´Ø¹Ø§Ø± + ØµÙˆØª + Ø¥Ø¹Ø§Ø¯Ø© Ù„ÙˆÙ† Ø§Ù„Ø²Ø±
      play('sndClose');
      showToast('âœ… ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø¨Ù†Ø¬Ø§Ø­ â€” ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ');
      const originalText='ğŸ› Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚';
      label.textContent='ğŸ› ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø¨Ù†Ø¬Ø§Ø­ âœ…';
      setTimeout(()=>{ 
        label.textContent=originalText; 
        btn.classList.remove('btn-gradient-anim');
        updateCloseButtonState(); 
      }, 2000);

      // Ø¥Ù†Ø´Ø§Ø¡ ØµÙ Ø¬Ø¯ÙŠØ¯
      ensureActiveRow();
    }
  },100);
}

/* ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØµÙ Ù†Ø´Ø· Ø¯Ø§Ø¦Ù…Ù‹Ø§ */
function ensureActiveRow(){
  const active = document.querySelector('#mainTableBody tr.active-row');
  if(!active){
    const autoSaved = JSON.parse(localStorage.getItem('activeRecordAutosave')||'null');
    currentRecordRow = createNewRow(null, autoSaved||null);
  }else{
    currentRecordRow = active;
  }
  updateCloseButtonState();
}

/* ØªØµØ¯ÙŠØ± Excel (XLS â€“ Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Excel) Ù„Ù„Ø´ÙØªØ§Øª Ø§Ù„Ù…ØºÙ„Ù‚Ø© ÙÙ‚Ø· */
function exportExcelClosed(){
  const rows=[["Ù…","Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù","Ø§Ù„ØªØ§Ø±ÙŠØ®/ÙˆÙ‚Øª Ø§Ù„Ø¥ØºÙ„Ø§Ù‚","ÙƒØ§Ø´","Visa","MasterCard","American","Ù…Ø¯ÙŠ","ØªØ­ÙˆÙŠÙ„ Ø¨Ù†Ùƒ","Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬","Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙŠÙˆÙ…ÙŠ","Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù","Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù"]];
  const allClosed=[...document.querySelectorAll('#mainTableBody tr.closed-row')];
  allClosed.forEach(tr=>{
    const id=tr.dataset.recordId||'';
    const t=[...tr.querySelectorAll('td')];
    const employee=tr.querySelector('.employee-box')?.innerText || '';
    const notesRow=document.querySelector(`#mainTableBody tr[data-record-id="${id}-notes"]`);
    const notes=notesRow ? notesRow.textContent.replace('Ù…Ù„Ø§Ø­Ø¸Ø©:','').trim() : '';
    rows.push([
      id, employee, t[4].innerText, t[5].innerText, t[6].innerText, t[7].innerText, t[8].innerText, t[9].innerText,
      t[10].innerText, t[11].innerText, t[2].innerText, t[12].innerText, notes
    ]);
  });

  if(rows.length===1){ showToast('â„¹ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´ÙØªØ§Øª Ù…ØºÙ„Ù‚Ø© Ù„Ù„ØªØµØ¯ÙŠØ±'); return; }

  const xmlHeader=`<?xml version="1.0"?>
  <?mso-application progid="Excel.Sheet"?>
  <Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet"
            xmlns:o="urn:schemas-microsoft-com:office:office"
            xmlns:x="urn:schemas-microsoft-com:office:excel"
            xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">
    <Styles>
      <Style ss:ID="sHeader"><Font ss:Bold="1"/><Interior ss:Color="#F7F2E1" ss:Pattern="Solid"/></Style>
      <Style ss:ID="sNum"><NumberFormat ss:Format="Standard"/></Style>
    </Styles>
    <Worksheet ss:Name="Closures">
      <Table>`;
  const xmlRows = rows.map((r,i)=>`<Row>`+r.map((c,ci)=>{
    const isNumber = (ci>=3 && ci<=11) && String(c).trim()!=='' && !isNaN(Number(String(c).replace(/,/g,'')));
    const data = String(c).replace(/&/g,'&amp;').replace(/</g,'&lt;');
    const style = i===0 ? ' ss:StyleID="sHeader"' : (isNumber ? ' ss:StyleID="sNum"' : '');
    return `<Cell${style}><Data ss:Type="${isNumber?'Number':'String'}">${isNumber?Number(String(c).replace(/,/g,'')):data}</Data></Cell>`;
  }).join('')+`</Row>`).join('');
  const xmlFooter = `</Table>
      <WorksheetOptions xmlns="urn:schemas-microsoft-com:office:excel">
        <PageSetup>
          <Layout x:Orientation="Landscape"/>
          <Header x:Data="Elite Operations â€“ Managed by Ayman Abu Warda"/>
          <PageMargins x:Top="0.4" x:Right="0.3" x:Left="0.3" x:Bottom="0.4"/>
        </PageSetup>
        <Print>
          <ValidPrinterInfo/>
          <PaperSizeIndex>9</PaperSizeIndex>
        </Print>
      </WorksheetOptions>
    </Worksheet>
  </Workbook>`;

  const blob=new Blob([xmlHeader+xmlRows+xmlFooter],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;charset=utf-8;'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  const d=new Date().toISOString().slice(0,10);
  a.href=url; a.download=`cash_closures_${d}.xlsx`; a.click();
  URL.revokeObjectURL(url);
  showToast('ğŸ“¤ ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø´ÙØªØ§Øª Ø§Ù„Ù…ØºÙ„Ù‚Ø© (Excel)');
}

/* Ø·Ø¨Ø§Ø¹Ø© Ù…Ø¨Ø§Ø´Ø±Ø© (A4 Landscape) */
function printDirect(){
  const tbody=document.getElementById('printTbody');
  tbody.innerHTML='';
  const closed=[...document.querySelectorAll('#mainTableBody tr.closed-row')];
  if(closed.length===0){ showToast('â„¹ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´ÙØªØ§Øª Ù…ØºÙ„Ù‚Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©'); return; }
  closed.forEach(tr=>{
    const id=tr.dataset.recordId||'';
    const t=tr.querySelectorAll('td');
    const employee=tr.querySelector('.employee-box')?.innerText || '';
    const notesRow=document.querySelector(`#mainTableBody tr[data-record-id="${id}-notes"]`);
    const notes=notesRow ? notesRow.textContent.replace('Ù…Ù„Ø§Ø­Ø¸Ø©:','').trim() : '';
    const row=document.createElement('tr');
    row.innerHTML = `
      <td>${id}</td><td>${employee}</td><td>${t[4].innerText}</td>
      <td>${t[5].innerText}</td><td>${t[6].innerText}</td><td>${t[7].innerText}</td><td>${t[8].innerText}</td><td>${t[9].innerText}</td>
      <td>${t[10].innerText}</td><td>${t[11].innerText}</td><td>${t[2].innerText}</td><td>${t[12].innerText}</td><td>${notes}</td>
    `;
    tbody.appendChild(row);
  });
  document.getElementById('printDate').textContent=new Date().toLocaleDateString('ar-EG');
  document.getElementById('printFooter').textContent = `ØªÙ…Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø¨ÙˆØ§Ø³Ø·Ø© â€“ ${storedEmployeeName}`;

  const sheet=document.getElementById('printSheet');
  sheet.style.display='block';
  window.onafterprint=()=>{ sheet.style.display='none'; };
  window.print();
}

/* ØªÙ‡ÙŠØ¦Ø© */
document.addEventListener('DOMContentLoaded', ()=>{
  document.getElementById('dateNow').textContent=new Date().toLocaleString('ar-EG');

  // ØªØ­ÙŠØ© ÙˆÙ‚ØªÙŠØ©
  const hr=(new Date()).getHours();
  const greet=document.getElementById('greet');
  if(hr>=5 && hr<12) greet.textContent='ØµØ¨Ø§Ø­ Ø§Ù„Ø®ÙŠØ± ğŸŒ';
  else if(hr>=12 && hr<20) greet.textContent='Ù…Ø³Ø§Ø¡ Ø§Ù„ÙˆØ±Ø¯ ğŸŒ™';
  else greet.textContent='Ù„ÙŠÙ„Ø© Ø³Ø¹ÙŠØ¯Ø© âœ¨';

  // Ø¯Ø®ÙˆÙ„
  const nameInput=document.getElementById('employeeNameInput');
  const startBtn=document.getElementById('startWorkBtn');
  nameInput.addEventListener('input', ()=> startBtn.disabled = (nameInput.value.trim().length<2));

// âœ… Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø¨Ø§Ø´Ø±Ø©
nameInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !startBtn.disabled) {
    startBtn.click();
  }
});
// ğŸ’¡ [Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ]
  startBtn.addEventListener('click', ()=>{
    storedEmployeeName = nameInput.value.trim();
    localStorage.setItem('username', storedEmployeeName); // Ø­ÙØ¸ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ø£Ø¯Ù…Ù†

    document.body.classList.remove('locked');
    document.getElementById('login').style.display='none';
    setUserUI();
    
    // ğŸ’¡ Ø£ÙˆÙ„Ø§Ù‹ØŒ Ù‚Ù… Ø¨Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…ØºÙ„Ù‚Ø© Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø©
    if (typeof restoreClosedRecords === 'function') {
      restoreClosedRecords();
    }
    
    // ğŸ’¡ Ø«Ø§Ù†ÙŠÙ‹Ø§ØŒ ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØµÙ Ù†Ø´Ø·
    ensureActiveRow();
    
    // ğŸ’¡ (Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ Ø³ÙŠÙ‚ÙˆÙ… Ø¨Ø¥Ø¶Ø§ÙØ© Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø¯Ù…Ù† ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø³Ø¬Ù„Ø§Øª)
    
    play('sndIntro');
  });

  // Ø£Ø²Ø±Ø§Ø±
  document.getElementById('newRowBtn').addEventListener('click', ()=>{ createNewRow(); updateCloseButtonState(); });
  document.getElementById('closeBtn').addEventListener('click', closeActiveRow);
  document.getElementById('clearCashBtn').addEventListener('click', ()=>{ document.querySelectorAll('#cashCalc td[contenteditable]').forEach(td=> td.textContent=''); recalcCash(); });
  document.getElementById('logoutBtn').addEventListener('click', ()=>{
    
    play('sndLogout'); showToast('ğŸ’¾ ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øªâ€¦');
    setTimeout(()=>{
      document.getElementById('login').style.display='flex';
      document.body.classList.add('locked');
      document.getElementById('employeeNameInput').value='';
    }, 3000);
  });
  document.getElementById('exportBtn').addEventListener('click', exportExcelClosed);
  document.getElementById('printBtn').addEventListener('click', printDirect);

  // ØªØ­Ø¯ÙŠØ« Ø¨ØµÙ…Ø© Ø¢Ø®Ø± ØªØ¹Ø¯ÙŠÙ„
  document.addEventListener('input', e=>{
    if(e && e.target && (e.target.id==='notesBox' || e.target.tagName==='TEXTAREA' || e.target.closest && e.target.closest('#notesContainer'))) return;
    if(e.target && e.target.closest('#mainTableBody')){ document.getElementById('lastUpdate').textContent="ğŸ•“ Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: "+new Date().toLocaleString('ar-EG'); }
  });
});

// ğŸŒ™ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„ÙˆØ¶Ø¹ÙŠÙ†
const themeToggle = document.getElementById('themeToggle');
const savedTheme = localStorage.getItem('theme') || 'dark';
document.body.dataset.theme = savedTheme;
themeToggle.textContent = savedTheme === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';

themeToggle.addEventListener('click', () => {
  const newTheme = document.body.dataset.theme === 'dark' ? 'light' : 'dark';
  document.body.dataset.theme = newTheme;
  localStorage.setItem('theme', newTheme);
  themeToggle.textContent = newTheme === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';
});

</script>
<script>
/* === v5.8 Helpers === */
function skyGlow(){
  try{
    let g=document.getElementById('skyGlow');
    if(!g){ g=document.createElement('div'); g.id='skyGlow'; document.body.appendChild(g); }
    g.classList.add('show');
    setTimeout(()=>{ g.classList.remove('show'); g.classList.add('hide'); }, 800);
    setTimeout(()=>{ if(g && g.parentNode) g.parentNode.removeChild(g); }, 1600);
  }catch(e){ console.warn(e); }
}

/* mini toast inside calculator */
function calcMiniToast(text){
  try{
    const calcWrap=document.querySelector('.calc-grid')?.parentElement || document.querySelector('.calc-grid');
    if(!calcWrap) return;
    const old=calcWrap.querySelector('.calc-mini-toast'); if(old) old.remove();
    const t=document.createElement('div'); t.className='calc-mini-toast'; t.textContent=text||'';
    calcWrap.style.position='relative';
    calcWrap.appendChild(t);
    setTimeout(()=>{ t.style.transition='opacity .4s ease'; t.style.opacity='0'; }, 1600);
    setTimeout(()=>{ t.remove(); }, 2100);
  }catch(e){ console.warn(e); }
}

/* close button visual enhancer */
function refreshCloseBtnState(){
  try{
    const btn=document.getElementById('closeBtn');
    if(!btn) return;
    const isDisabled = btn.hasAttribute('disabled') || btn.classList.contains('is-disabled');
    btn.classList.toggle('disabled', !!isDisabled);
    btn.classList.toggle('ready', !isDisabled);
  }catch(e){ console.warn(e); }
}
function hookCloseBtnState(){
  try{
    const btn=document.getElementById('closeBtn');
    if(!btn) return;
    refreshCloseBtnState();
    const mo=new MutationObserver(refreshCloseBtnState);
    mo.observe(btn, { attributes:true, attributeFilter:['class','disabled'] });
  }catch(e){ console.warn(e); }
}

/* top banner helper (if not exists already) */
function showWelcomeBanner(msg){
  try{
    const old=document.getElementById('welcomeBanner'); if(old) old.remove();
    const b=document.createElement('div'); b.id='welcomeBanner'; b.textContent=msg||'';
    b.style.position='fixed'; b.style.top='10px'; b.style.left='50%'; b.style.transform='translateX(-50%)';
    b.style.background='linear-gradient(135deg, rgba(245,197,66,.9), rgba(234,179,8,.9))';
    b.style.color='#1f2937'; b.style.border='1px solid rgba(255,255,255,.25)';
    b.style.padding='10px 16px'; b.style.borderRadius='12px'; b.style.fontWeight='900'; b.style.zIndex='3500';
    b.style.boxShadow='0 10px 30px rgba(0,0,0,.25), 0 0 18px rgba(245,197,66,.35)';
    document.body.appendChild(b);
    setTimeout(()=>{ b.style.transition='opacity .5s ease, transform .5s ease'; b.style.opacity='0'; b.style.transform='translateX(-50%) translateY(-6px)'; }, 1200);
    setTimeout(()=>{ b.remove(); }, 1800);
  }catch(e){ console.warn(e); }
}

// ğŸŒ™ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„ÙˆØ¶Ø¹ÙŠÙ†
const themeToggle = document.getElementById('themeToggle');
const savedTheme = localStorage.getItem('theme') || 'dark';
document.body.dataset.theme = savedTheme;
themeToggle.textContent = savedTheme === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';

themeToggle.addEventListener('click', () => {
  const newTheme = document.body.dataset.theme === 'dark' ? 'light' : 'dark';
  document.body.dataset.theme = newTheme;
  localStorage.setItem('theme', newTheme);
  themeToggle.textContent = newTheme === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';
});

</script>
<script>
document.addEventListener('DOMContentLoaded', ()=>{
  try{
    // If there is a login, trigger sky glow right after successful login.
    const startBtn=document.getElementById('startWorkBtn');
    if(startBtn){
      startBtn.addEventListener('click', ()=>{ setTimeout(()=>skyGlow(), 50); }, {capture:false});
    }
    const nameInput=document.getElementById('employeeNameInput');
    if(nameInput){
      nameInput.addEventListener('keydown', e=>{ if(e.key==='Enter'){ setTimeout(()=>skyGlow(), 50); }});
    }
  }catch(e){ console.warn(e); }

  // Enhance close button visual state
  hookCloseBtnState();

  // Show success banner after pressing close (best-effort)
  try{
    const cb=document.getElementById('closeBtn');
    if(cb){
      cb.addEventListener('click', ()=>{
        // give the original logic time to finish
        setTimeout(()=>{ showWelcomeBanner('âœ… ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø¨Ù†Ø¬Ø§Ø­'); refreshCloseBtnState(); }, 600);
      });
    }
  }catch(e){ console.warn(e); }
});

// ğŸŒ™ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„ÙˆØ¶Ø¹ÙŠÙ†
const themeToggle = document.getElementById('themeToggle');
const savedTheme = localStorage.getItem('theme') || 'dark';
document.body.dataset.theme = savedTheme;
themeToggle.textContent = savedTheme === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';

themeToggle.addEventListener('click', () => {
  const newTheme = document.body.dataset.theme === 'dark' ? 'light' : 'dark';
  document.body.dataset.theme = newTheme;
  localStorage.setItem('theme', newTheme);
  themeToggle.textContent = newTheme === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';
});

</script>
<script>
// === v6.1 Calculator History (persistent) ===
(function(){
  const KEY='calcHistoryPersist';
  let exprBuffer=''; // builds expression live when we can't hook native logic
  function qs(sel,root){ return (root||document).querySelector(sel); }
  function qsa(sel,root){ return Array.from((root||document).querySelectorAll(sel)); }
  function getCalcRoot(){
    // The calculator wrapper likely contains .calc-grid; fall back to a container with title "Ø¢Ù„Ø© Ø­Ø§Ø³Ø¨Ø©"
    const grid = qs('.calc-grid');
    if(grid) return grid.parentElement || grid;
    const headings = qsa('h2,h3,h4');
    const t = headings.find(h=>/Ø­Ø§Ø³Ø¨Ø©/.test(h.textContent));
    return t ? t.parentElement : document.body;
  }
  function getDisplay(){
    const root=getCalcRoot();
    return qs('input[type="text"], input.calc-display, .calc-display, .display, .screen', root);
  }
  function ensurePanel(){
    const root=getCalcRoot();
    let p = qs('#calcHistoryPanel', root);
    if(!p){
      p = document.createElement('div');
      p.id='calcHistoryPanel';
      // place after grid if exists
      const g = qs('.calc-grid', root);
      if(g && g.parentElement) g.parentElement.appendChild(p);
      else root.appendChild(p);
    }
    return p;
  }
  function saveHistory(items){
    try{ localStorage.setItem(KEY, JSON.stringify(items.slice(0,10))); }catch(e){}
  }
  function loadHistory(){
    try{ return JSON.parse(localStorage.getItem(KEY)||'[]') || []; }catch(e){ return []; }
  }
  function renderHistory(){
    const p=ensurePanel();
    const items=loadHistory();
    p.innerHTML='';
    items.forEach(txt=>{
      const d=document.createElement('div');
      d.className='h-item';
      d.textContent=txt;
      d.addEventListener('click', ()=>{
        const disp=getDisplay();
        if(disp){ disp.value = txt.split('=').shift().trim(); }
        // gentle sound (optional)
        try{ if(window.play) play('sndWelcome'); }catch(_){}
      });
      p.appendChild(d);
    });
  }
  function addHistory(txt){
    const items=loadHistory();
    items.unshift(txt);
    saveHistory(items);
    const p=ensurePanel();
    const d=document.createElement('div');
    d.className='h-item new';
    d.textContent=txt;
    d.addEventListener('click', ()=>{
      const disp=getDisplay();
      if(disp){ disp.value = txt.split('=').shift().trim(); }
      try{ if(window.play) play('sndWelcome'); }catch(_){}
    });
    p.insertBefore(d, p.firstChild);
  }
  function miniToast(msg){
    const grid = qs('.calc-grid');
    if(!grid) return;
    const wrap = grid.parentElement || grid;
    wrap.style.position='relative';
    const old = qs('.calc-mini-toast', wrap); if(old) old.remove();
    const t = document.createElement('div');
    t.className='calc-mini-toast'; t.textContent=msg;
    wrap.appendChild(t);
    setTimeout(()=>{ t.style.transition='opacity .4s ease'; t.style.opacity='0'; }, 1600);
    setTimeout(()=>{ t.remove(); }, 2100);
  }
  function clearHistory(){
    saveHistory([]);
    renderHistory();
    miniToast('ğŸ§¹ ØªÙ… Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª');
  }

  // Hook logic
  document.addEventListener('DOMContentLoaded', ()=>{
    renderHistory();
    const disp = getDisplay();
    const grid = qs('.calc-grid');
    // 1) If global append(k) exists, patch it to observe '=' and 'C'
    if(typeof window.append === 'function'){
      const _append = window.append;
      window.append = function(k){
        // When user types, we try to build the expression if we can't read it
        if(k && k !== '=' && k !== 'C'){ exprBuffer += String(k); }
        if(k === 'C'){ clearHistory(); exprBuffer=''; }
        const r = _append.apply(this, arguments);
        if(k === '='){
          setTimeout(()=>{
            const d = getDisplay();
            const val = d ? (d.value||d.textContent||'').trim() : '';
            const expr = exprBuffer || (d ? (d.getAttribute('data-last-expr')||'') : '');
            const line = expr ? `${expr} = ${val}` : `${val}`;
            if(val) addHistory(line);
            exprBuffer='';
          }, 0);
        }
        return r;
      };
    } else if(grid){
      // 2) Fallback: listen to buttons
      grid.addEventListener('click', (e)=>{
        const b = e.target.closest('button');
        if(!b) return;
        const k = (b.dataset.k || b.textContent || '').trim();
        if(!k) return;
        if(k==='C'){ clearHistory(); exprBuffer=''; return; }
        if(k==='='){
          setTimeout(()=>{
            const d = getDisplay();
            const val = d ? (d.value||d.textContent||'').trim() : '';
            const line = exprBuffer ? `${exprBuffer} = ${val}` : `${val}`;
            if(val) addHistory(line);
            exprBuffer='';
          }, 0);
          return;
        }
        // build expression text (visual, not used by calculator engine)
        const map = {'Ã·':'/','Ã—':'*','+':'+','-':'-','Ù«':'.'};
        exprBuffer += map[k] || k;
      });
    }

    // Expose clear for C buttons bound elsewhere
    window.__calcClearHistory = clearHistory;
  });

  // If any 'C' button exists but not wired, wire it to also clear history
  document.addEventListener('click', (e)=>{
    const b = e.target.closest('button');
    if(!b) return;
    const k = (b.dataset.k || b.textContent || '').trim();
    if(k==='C'){ try{ window.__calcClearHistory && window.__calcClearHistory(); }catch(_){} }
  });
})();
</script>
<div id="goldFlash"></div>
<audio id="sndFinalClose" preload="auto" src="data:audio/wav;base64,UklGRkAAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=" type="audio/wav"></audio>
<style>
#goldFlash {
  position:fixed; inset:0;
  background:radial-gradient(circle at center, rgba(245,197,66,0.3), transparent 70%);
  opacity:0; pointer-events:none; z-index:3000;
  transition:opacity 0.8s ease;
}
#goldFlash.show { opacity:1; animation: fadeOutFlash 1.2s ease forwards; }
@keyframes fadeOutFlash {
  0% { opacity:0.9; }
  50% { opacity:0.6; }
  100% { opacity:0; }
}

.row-fade-in { animation: fadeInRow 0.8s ease both; }
@keyframes fadeInRow { from { opacity:0; transform:scale(0.98); } to { opacity:1; transform:scale(1); } }

</style>

<script>
function triggerGoldFlash(){
  const flash=document.getElementById('goldFlash');
  flash.classList.remove('show');
  void flash.offsetWidth;
  flash.classList.add('show');
}
function playFinalSound(){
  try {
    const snd=document.getElementById('sndFinalClose');
    snd.currentTime=0;
    snd.play();
  } catch(e) { console.warn('sound play error',e); }
}
// ÙˆÙ…ÙŠØ¶ ØªØ±Ø­ÙŠØ¨ÙŠ Ø¹Ù†Ø¯ Ø£ÙˆÙ„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
window.addEventListener('DOMContentLoaded',()=>{
  if(!sessionStorage.getItem('welcomed')){
    triggerGoldFlash();
    playFinalSound();
    sessionStorage.setItem('welcomed','1');
  }
});
</script>
<style>
# top:20px; right:50%; transform:translateX(50%);
  background:rgba(245,197,66,0.15);
  border:1px solid rgba(245,197,66,0.4);
  color:#f5c542; font-family:'Tajawal',sans-serif;
  padding:10px 20px; border-radius:12px;
  font-size:14px; font-weight:600; opacity:0; transition:opacity .6s ease;
  z-index:4000; box-shadow:0 0 12px rgba(245,197,66,0.25);
}
# animation:fadeOut 2.5s ease forwards; }
@keyframes fadeOut {
  0%,70%{opacity:1;}100%{opacity:0;}
}

.row-fade-in { animation: fadeInRow 0.8s ease both; }
@keyframes fadeInRow { from { opacity:0; transform:scale(0.98); } to { opacity:1; transform:scale(1); } }

</style>

<script>
// ğŸŸ¡ Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙÙŠÙ„Ø§Øª Ø¹Ù†Ø¯ ÙƒÙ„ ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª
function saveClosuresToLocal(){
  try {
    const table = document.querySelector('table');
    if(!table) return;
    const rows = [...table.querySelectorAll('tr')].map(r => r.innerText.trim());
    localStorage.setItem('closures_backup', JSON.stringify(rows));
  } catch(e){ console.warn('saveClosures error', e); }
}

// ğŸŸ¢ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„ØªÙ‚ÙÙŠÙ„Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø±ÙŠÙØ±ÙŠØ´
function restoreClosuresFromLocal(){
  try {
    const backup = JSON.parse(localStorage.getItem('closures_backup') || '[]');
    if(backup.length > 0){
      const notice = document.getElementById('
      // ğŸ’¡ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø³Ø¬Ù„Ø§Øª Ù…ØºÙ„Ù‚Ø© ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹Ù‡Ø§ ÙØ¹Ù„Ø§Ù‹ØŒ Ø§Ø¸Ù‡Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
      const closedRecords = (JSON.parse(localStorage.getItem(STORE_KEY)||'[]') || []).length;
      if (closedRecords > 0) {
        notice.classList.add('show');
      }
      console.log('ğŸ” Restored closures:', backup);
    }
  } catch(e){ console.warn('restoreClosures error', e); }
}

// ğŸ§  Ø¹Ù†Ø¯ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø£Ùˆ Ø§Ù„ØªÙ‚ÙÙŠÙ„ ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸
window.addEventListener('beforeunload', saveClosuresToLocal);
// ğŸŒŸ Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­ ÙŠØªÙ… Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©
// [ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡] ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¥Ù„Ù‰ Ù…Ø§ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
// window.addEventListener('DOMContentLoaded', restoreClosuresFromLocal);
</script>
<style>
.reactivated-row {
  background:linear-gradient(90deg, rgba(245,197,66,0.15), rgba(245,197,66,0.05));
  transition:background 0.5s ease;
}
.reactivate-badge {
  display:inline-block;
  margin-right:8px;
  padding:3px 8px;
  border-radius:8px;
  background:rgba(245,197,66,0.15);
  border:1px solid rgba(245,197,66,0.4);
  color:#f5c542;
  font-size:12px;
  font-weight:600;
  font-family:'Tajawal',sans-serif;
  animation:fadeOutBadge 5s ease forwards;
}
@keyframes fadeOutBadge {
  0%,80%{opacity:1;}100%{opacity:0;}
}

.row-fade-in { animation: fadeInRow 0.8s ease both; }
@keyframes fadeInRow { from { opacity:0; transform:scale(0.98); } to { opacity:1; transform:scale(1); } }

</style>

<script>
function reactivateRow(row){
  try {
    row.classList.add('reactivated-row');
    // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø¥Ù‚ÙØ§Ù„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
    row.dataset.locked = 'false';
    // Ø´Ø§Ø±Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡
    const badge = document.createElement('span');
    badge.className = 'reactivate-badge';
    badge.textContent = 'âš™ï¸ ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙ';
    row.cells[0].prepend(badge);
  } catch(e){ console.warn('reactivateRow error', e); }
}

// Ù…Ø«Ø§Ù„: Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¥Ù‚ÙØ§Ù„
function undoLock(row){
  // Ø¥Ø²Ø§Ù„Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù‚ÙÙ„
  row.classList.remove('locked-row');
  reactivateRow(row);
}

// ğŸŒ™ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„ÙˆØ¶Ø¹ÙŠÙ†
const themeToggle = document.getElementById('themeToggle');
const savedTheme = localStorage.getItem('theme') || 'dark';
document.body.dataset.theme = savedTheme;
themeToggle.textContent = savedTheme === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';

themeToggle.addEventListener('click', () => {
  const newTheme = document.body.dataset.theme === 'dark' ? 'light' : 'dark';
  document.body.dataset.theme = newTheme;
  localStorage.setItem('theme', newTheme);
  themeToggle.textContent = newTheme === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';
});

</script>
<script>
// âœ… Ø¬Ø¹Ù„ Ø§Ù„ØµÙ Ù‚Ø§Ø¨Ù„Ù‹Ø§ Ù„Ù„Ø¥Ù‚ÙØ§Ù„ ÙÙˆØ±Ù‹Ø§ Ø¨Ø¹Ø¯ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¥Ù‚ÙØ§Ù„ (Ø¨Ø¯ÙˆÙ† Ø£ÙŠ ØªØ¹Ø¯ÙŠÙ„)
function forceReadyToClose(row){
  try{
    if(!row) return;
    currentRecordRow = row; // Ø§Ø¬Ø¹Ù„Ù‡ Ø§Ù„ØµÙ Ø§Ù„Ù†Ø´Ø·
    const btn = document.getElementById('closeBtn');
    const employeeBox = row.querySelector('.employee-box');
    const sameUser = employeeBox && employeeBox.textContent.trim().toLowerCase() === (storedEmployeeName||'').toLowerCase();
    const revenueOk = (row.cells && row.cells[11]) ? (parseFloat(String(row.cells[11].textContent).replace(/[^\d.-]/g,''))>0) : true;
    // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø¥Ù‚ÙØ§Ù„ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¥Ø°Ø§ ØªÙˆØ§ÙØ±Øª Ø§Ù„Ø´Ø±ÙˆØ·
    if(sameUser && revenueOk){
      btn.disabled = false;
      btn.classList.remove('disabled');
      btn.classList.add('ready');
      // ÙˆØ§Ø¬Ù‡Ø© Ù…Ø±Ø¦ÙŠØ© ØµØºÙŠØ±Ø©
      try { document.getElementById('closeLabel').textContent = 'ğŸ› Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚'; } catch(_){}
    }
  }catch(e){ console.warn('forceReadyToClose error', e); }
}

// ğŸŸ¡ Ø¶Ø® Ø´Ø§Ø±Ø© ÙˆØ¥Ø¨Ù‚Ø§Ø¡ ØªØ£Ø«ÙŠØ± Ø°Ù‡Ø¨ÙŠ Ø­ØªÙ‰ Ø§Ù„Ø¥Ù‚ÙØ§Ù„
function reactivateRow(row){
  try {
    row.classList.add('active-row');
    row.classList.remove('closed-row');
    row.classList.add('reactivated-row');
    // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ­Ø±ÙŠØ± Ø¥Ù† Ø£Ø±Ø¯Øª Ù„Ø§Ø­Ù‚Ù‹Ø§ (Ù„ÙŠØ³ Ù…Ø·Ù„ÙˆØ¨Ù‹Ø§ Ù„Ù„Ø¥Ù‚ÙØ§Ù„)
    row.querySelectorAll('td:not(:first-child):not(:nth-child(4)):not(:nth-child(13))').forEach(td=> td.setAttribute('contenteditable','true'));
    // Ø§Ù„Ø´Ø§Ø±Ø©
    const badge = document.createElement('span');
    badge.className = 'reactivate-badge';
    badge.textContent = 'âš™ï¸ ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙ';
    row.cells[0].prepend(badge);
    // Ø¬Ø§Ù‡Ø²ÙŠØ© ÙÙˆØ±ÙŠØ© Ù„Ù„Ø¥Ù‚ÙØ§Ù„
    forceReadyToClose(row);
  } catch(e){ console.warn('reactivateRow error', e); }
}

// ğŸ§½ Ø¹Ù†Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ù‚ÙØ§Ù„ Ù‚Ù… Ø¨Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø¤Ø«Ø± Ø§Ù„Ø°Ù‡Ø¨ÙŠ
(function patchCloseActiveRow(){
  const _orig = window.closeActiveRow;
  if(typeof _orig === 'function'){
    window.closeActiveRow = function(){
      const before = currentRecordRow;
      _orig.apply(this, arguments);
      try{
        if(before){ before.classList.remove('reactivated-row'); }
      }catch(e){}
    };
  }
})();

// ğŸª„ ÙÙŠ Ø­Ø§Ù„ ÙƒØ§Ù† Ù„Ø¯ÙŠÙƒ Ø¯Ø§Ù„Ø© undoClose Ø§Ù„Ø£ØµÙ„ÙŠØ©ØŒ Ù‚Ù… Ø¨Ø­Ù‚Ù† forceReady Ø¨Ø¹Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ÙØªØ­
(function patchUndoClose(){
  const _origUndo = window.undoClose;
  if(typeof _origUndo === 'function'){
    window.undoClose = function(row, recordId){
      _origUndo.apply(this, arguments);
      try{ reactivateRow(row); }catch(e){}
    };
  }
})();

// ğŸŒ™ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„ÙˆØ¶Ø¹ÙŠÙ†
const themeToggle = document.getElementById('themeToggle');
const savedTheme = localStorage.getItem('theme') || 'dark';
document.body.dataset.theme = savedTheme;
themeToggle.textContent = savedTheme === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';

themeToggle.addEventListener('click', () => {
  const newTheme = document.body.dataset.theme === 'dark' ? 'light' : 'dark';
  document.body.dataset.theme = newTheme;
  localStorage.setItem('theme', newTheme);
  themeToggle.textContent = newTheme === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';
});

</script>
<script>
// === v7.2 Fixes ===

// Helper: check if a row has any user input (contenteditable cells not empty)
function rowHasInput(tr){
  try{
    const editables = tr.querySelectorAll('td[contenteditable]');
    for(const td of editables){
      if((td.textContent||'').trim() !== '') return true;
    }
  }catch(e){}
  return false;
}

// Override undoClose to keep any existing active row that has inputs
window.undoClose = function(row, recordId){
  try{
    // 1) remove record from storage
    let records=JSON.parse(localStorage.getItem(STORE_KEY)||'[]') || [];
    const idx=records.findIndex(r=>r.id==recordId); let last=null;
    if(idx>-1){ last=records.splice(idx,1)[0]; localStorage.setItem(STORE_KEY, JSON.stringify(records)); }

    // 2) DO NOT delete any existing active row with inputs
    const newActive=document.querySelector('#mainTableBody tr.active-row');
    if(newActive && !rowHasInput(newActive)){
      // if empty, it's safe to remove to avoid duplicates
      newActive.remove();
    }

    // 3) Reactivate the target row
    row.classList.remove('closed-row'); row.classList.add('active-row','reactivated-row');
    row.querySelectorAll('td:not(:first-child):not(:nth-child(4)):not(:nth-child(13))').forEach(td=> td.setAttribute('contenteditable','true'));
    row.cells[4].innerHTML=''; row.cells[13].innerHTML='';
    const employeeBox=row.querySelector('.employee-box'); if(employeeBox) employeeBox.setAttribute('contenteditable','false');
    if(typeof injectDeleteButtonInto==='function') injectDeleteButtonInto(row);
    currentRecordRow=row;

    // 4) restore auxiliary data
    if(last){ try{ setCashCalcData(last.cashCalc); document.getElementById('notesBox').value=last.notes||''; }catch(e){} }

    // 5) ready to close again immediately
    if(typeof bindEditable==='function') bindEditable(row);
    if(typeof recalc==='function') recalc();
    if(typeof forceReadyToClose==='function') forceReadyToClose(row);
    if(typeof updateCloseButtonState==='function') updateCloseButtonState();

    // 6) badge
    try{
      const badge=document.createElement('span'); badge.className='reactivate-badge'; badge.textContent='âš™ï¸ ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙ';
      row.cells[0].prepend(badge);
    }catch(e){}
  }catch(e){ console.warn('undoClose override error', e); }
};

// Restore closed records from localStorage on refresh
function restoreClosedRecords(){
  try{
    const records=JSON.parse(localStorage.getItem(STORE_KEY)||'[]') || [];
    if(!Array.isArray(records) || records.length===0) return;
    const existingClosed=document.querySelectorAll('#mainTableBody tr.closed-row').length;
    if(existingClosed>0) return; // already on screen

    records.sort((a,b)=> (a.id||0)-(b.id||0)).forEach(r=>{
      // create closed row using existing helper
      if(typeof createNewRow==='function'){
        const tr=createNewRow(r); // createNewRow treats rowData.closeTime as closed
        try{ if(typeof showFinalClosureInfo==='function') showFinalClosureInfo(tr, r.id); }catch(e){}
      }
    });

    // visual notice
    try{
      const notice=document.getElementById('
      if(notice){ notice.classList.add('show'); }
    }catch(e){}
    if(typeof calculateMetricsFromDOM==='function') calculateMetricsFromDOM();
  }catch(e){ console.warn('restoreClosedRecords error', e); }
}

// [ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡] ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¥Ù„Ù‰ Ù…Ø§ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
// window.addEventListener('DOMContentLoaded', restoreClosedRecords);
</script>
<style>
.final-info {
  font-family: 'Tajawal', sans-serif !important;
  font-size: 12.5px !important;
  line-height: 1.4;
  font-weight: 500;
  color: #f3f4f6;
  text-align: center;
  background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 12px;
  padding: 8px 10px;
  box-shadow: 0 0 10px rgba(0,0,0,0.2), inset 0 0 5px rgba(255,255,255,0.05);
  letter-spacing: 0.2px;
}
.final-info span {
  display: block;
  font-size: 11px;
  opacity: 0.8;
  color: #f5c542;
  margin-top: 3px;
}

/* ğŸ¯ Ø²Ø± Ø§Ù„Ø­Ø°Ù Ù„Ù„Ø£Ø¯Ù…Ù† ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¹Ù†Ø¯ ØªÙ…Ø±ÙŠØ± Ø§Ù„Ù…Ø§ÙˆØ³ */
.instant-delete-btn {
  opacity: 0;
  transition: opacity 0.3s ease;
  background: rgba(245,197,66,0.15);
  color: #f5c542;
  border: 1px solid rgba(245,197,66,0.3);
  border-radius: 8px;
  padding: 3px 8px;
  font-size: 11px;
  cursor: pointer;
  margin-top: 6px;
}
tr.closed-row:hover .instant-delete-btn {
  opacity: 1;
}

/* âœ¨ ØªÙˆÙ‡Ø¬ Ø°Ù‡Ø¨ÙŠ Ø­ÙˆÙ„ ÙƒØ§Ù…Ù„ Ø§Ù„ØµÙ Ø¹Ù†Ø¯ ØªÙ…Ø±ÙŠØ± Ø§Ù„Ù…Ø§ÙˆØ³ */
tr.closed-row:hover {
  box-shadow: 0 0 14px rgba(245,197,66,0.3);
  transition: box-shadow 0.3s ease;
}

/* ğŸ–ï¸ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø£Ø¯Ù…Ù† */
#adminNotice {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(245,197,66,0.15);
  color: #f5c542;
  border: 1px solid rgba(245,197,66,0.3);
  border-radius: 10px;
  padding: 8px 14px;
  font-family: 'Tajawal', sans-serif;
  font-size: 13px;
  font-weight: 600;
  box-shadow: 0 0 10px rgba(245,197,66,0.2);
  opacity: 0;
  transition: opacity 0.5s ease;
  z-index: 4000;
}
#adminNotice.show { opacity: 1; animation: fadeOutAdmin 2.2s ease forwards; }
@keyframes fadeOutAdmin {
  0%,70% { opacity: 1; }
  100% { opacity: 0; }
}

.row-fade-in { animation: fadeInRow 0.8s ease both; }
@keyframes fadeInRow { from { opacity:0; transform:scale(0.98); } to { opacity:1; transform:scale(1); } }

</style>

<div id="adminNotice">ğŸ–ï¸ ØªÙ… Ù…Ù†Ø­Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Admin Mode Enabled)</div>
<script>
// âœ… ØªØ­Ø¯ÙŠØ« Ù†Øµ Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ + ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø£Ø¯Ù…Ù†
function showFinalClosureInfo(row, recordId) {
  const cell = row.cells[13];
  cell.innerHTML = '';
  const info = document.createElement('div');
  info.className = 'final-info';

  const currentUser = (localStorage.getItem('username') || '').toLowerCase();
  const isAdmin = currentUser === 'ayman777adam';

  if (isAdmin) {
    // Ø§Ù„Ø£Ø¯Ù…Ù†: Ø­Ø°Ù ÙÙˆØ±ÙŠ Ø¨Ø¯ÙˆÙ† Ø§Ù†ØªØ¸Ø§Ø±
    info.innerHTML = 'ğŸ”’ ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø´ÙØª<span>ğŸ—‘ Ø­Ø°Ù ÙÙˆØ±ÙŠ (Admin)</span>';
    const deleteBtn = document.createElement('button');
    deleteBtn.textContent = 'Ø­Ø°Ù Ø§Ù„Ø¢Ù†';
    deleteBtn.className = 'instant-delete-btn';
    deleteBtn.onclick = () => deleteClosedRecord(recordId, row);
    info.appendChild(deleteBtn);
  } else {
    // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ø§Ø¯ÙŠ
    info.innerHTML = 'ğŸ”’ ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø´ÙØª<span>ğŸ•“ Ø§Ù„Ø­Ø°Ù Ø¨Ø¹Ø¯ 12 Ø³Ø§Ø¹Ø©</span>';
    startDeleteCountdown(row, recordId);
  }

  cell.appendChild(info);
}

// ğŸ–ï¸ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø£Ø¯Ù…Ù† Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
window.addEventListener('DOMContentLoaded', () => {
  const user = (localStorage.getItem('username') || '').toLowerCase();
  if (user === 'ayman777adam') {
    const notice = document.getElementById('adminNotice');
    if (notice) notice.classList.add('show');
  }
});
</script>
<style>
/* hide any old admin notices */
#adminNotice{display:none!important;}

/* final info text */
.final-info {
  font-family: 'Tajawal', sans-serif !important;
  font-size: 12.5px !important;
  line-height: 1.4;
  font-weight: 500;
  color: #f3f4f6;
  text-align: center;
  background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 12px;
  padding: 8px 10px;
  box-shadow: 0 0 10px rgba(0,0,0,0.2), inset 0 0 5px rgba(255,255,255,0.05);
  letter-spacing: 0.2px;
}
.final-info span {
  display: block;
  font-size: 11px;
  opacity: 0.8;
  color: #f5c542;
  margin-top: 3px;
}
.instant-delete-btn {
  display:inline-block;
  margin-top:6px;
  background:rgba(245,197,66,0.12);
  border:1px solid rgba(245,197,66,0.3);
  border-radius:8px;
  color:#f5c542;
  padding:5px 12px;
  font-family:'Tajawal',sans-serif;
  font-size:11.5px;
  cursor:pointer;
  transition:all 0.3s ease;
}
.instant-delete-btn:hover {
  background:rgba(245,197,66,0.25);
  transform:translateY(-1px);
}

/* glass confirm modal */
.confirm-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.45);
  display: flex; align-items: center; justify-content: center;
  z-index: 5000;
}
.confirm-modal {
  background: rgba(30,41,59,0.6);
  backdrop-filter: blur(12px);
  border: 1px solid rgba(245,197,66,0.3);
  border-radius: 12px;
  padding: 20px 30px;
  text-align: center;
  color: #f5c542;
  font-family: 'Tajawal', sans-serif;
  box-shadow: 0 0 20px rgba(245,197,66,0.2);
  animation: fadeInModal 0.3s ease;
}
@keyframes fadeInModal { from{opacity:0;transform:scale(0.9);} to{opacity:1;transform:scale(1);} }
.confirm-modal h3 { font-size:18px; margin-bottom:10px; }
.confirm-modal p { font-size:14px; color:#e2e8f0; margin-bottom:20px; }
.confirm-btns { display:flex; justify-content:center; gap:20px; }
.confirm-btns button {
  min-width:90px; padding:6px 12px; border-radius:8px;
  font-family:'Tajawal',sans-serif; font-weight:600;
  cursor:pointer; border:1px solid transparent; transition:all 0.3s ease;
}
.btn-confirm { color:#1e1e1e; background:#f5c542; border-color:#f5c542; }
.btn-confirm:hover { background:#f8d45f; }
.btn-cancel { color:#e2e8f0; background:rgba(255,255,255,0.05); border-color:rgba(255,255,255,0.2); }
.btn-cancel:hover { background:rgba(255,255,255,0.1); }

/* gold flash effect */
@keyframes goldFlash { from{box-shadow:0 0 20px rgba(245,197,66,0.8);} to{box-shadow:none;} }
.gold-flash { animation: goldFlash 0.5s ease; }

.row-fade-in { animation: fadeInRow 0.8s ease both; }
@keyframes fadeInRow { from { opacity:0; transform:scale(0.98); } to { opacity:1; transform:scale(1); } }

</style>

<script>
// âœ… Admin detection (any case / any localStorage key)
function isAdminUser(){
  const user = (
    localStorage.getItem('username') ||
    localStorage.getItem('currentUser') ||
    localStorage.getItem('loggedUser') ||
    storedEmployeeName || // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù…
    ''
  ).toLowerCase();
  return user.includes('ayman777adam');
}

// ğŸªŸ Glass confirm modal
function showConfirmModal(message, onConfirm){
  const overlay=document.createElement('div'); overlay.className='confirm-overlay';
  const modal=document.createElement('div'); modal.className='confirm-modal';
  modal.innerHTML=`<h3>âš ï¸ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</h3><p>${message||'Ù‡Ù„ ØªØ±ØºØ¨ ÙÙŠ ØªÙ†ÙÙŠØ° Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ØŸ'}</p>
    <div class='confirm-btns'>
      <button class='btn-cancel'>Ø¥Ù„ØºØ§Ø¡</button>
      <button class='btn-confirm'>ØªØ£ÙƒÙŠØ¯</button>
    </div>`;
  overlay.appendChild(modal);
  document.body.appendChild(overlay);
  overlay.addEventListener('click',e=>{ if(e.target===overlay) overlay.remove(); });
  modal.querySelector('.btn-cancel').onclick=()=>overlay.remove();
  modal.querySelector('.btn-confirm').onclick=()=>{ overlay.remove(); if(typeof onConfirm==='function') onConfirm(); };
}

// ğŸ’« Ø­Ø°Ù Ù…Ø¹ ÙˆÙ…ÙŠØ¶ Ø°Ù‡Ø¨ÙŠ
function deleteWithFlash(row, recordId, btn){
  if(btn){ btn.disabled=true; btn.textContent='Ø¬Ø§Ø±Ù Ø§Ù„Ø­Ø°Ù...'; btn.style.opacity='0.7'; }
  row.classList.add('gold-flash');
  setTimeout(()=>{ if(typeof deleteClosedRecord==='function') deleteClosedRecord(recordId,row); }, 400);
}

// ğŸ”’ ØªØ¹Ø¯ÙŠÙ„ Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚ÙÙŠÙ„Ø© Ù„ÙŠØ´Ù…Ù„ Ø²Ø± Ø§Ù„Ø­Ø°Ù Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·
function showFinalClosureInfo(row, recordId){
  const cell=row.cells[13]; cell.innerHTML='';
  const info=document.createElement('div'); info.className='final-info';
  if(isAdminUser()){
    info.innerHTML='ğŸ”’ ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø´ÙØª<span>ğŸ—‘ Ø­Ø°Ù ÙÙˆØ±ÙŠ (Admin)</span>';
    const delBtn=document.createElement('button');
    delBtn.className='instant-delete-btn';
    delBtn.innerHTML='ğŸ—‘ Ø­Ø°Ù ÙÙˆØ±ÙŠ';
    delBtn.onclick=()=>showConfirmModal('Ù‡Ù„ ØªØ±ØºØ¨ ÙÙŠ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ØªÙ‚ÙÙŠÙ„Ø© ÙÙˆØ±Ù‹Ø§ØŸ',()=>deleteWithFlash(row,recordId, delBtn));
    info.appendChild(delBtn);
  } else {
    info.innerHTML='ğŸ”’ ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø´ÙØª<span>ğŸ•“ Ø§Ù„Ø­Ø°Ù Ø¨Ø¹Ø¯ 12 Ø³Ø§Ø¹Ø©</span>';
    if(typeof startDeleteCountdown==='function') startDeleteCountdown(row,recordId);
  }
  cell.appendChild(info);
}

// ğŸ”„ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø£Ø¶Ù Ø²Ø± Ø§Ù„Ø­Ø°Ù Ø§Ù„ÙÙˆØ±ÙŠ Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙŠ ÙƒÙ„ Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ù…ØºÙ„Ù‚Ø©
window.addEventListener('DOMContentLoaded',()=>{
  const notice=document.getElementById('adminNotice'); if(notice) notice.remove();
  if(!isAdminUser()) return;
  document.querySelectorAll('tr.closed-row').forEach((row,i)=>{
    const cell=row.cells[13]; if(!cell) return;
    const box=cell.querySelector('.final-info'); if(!box) return;
    if(!box.querySelector('.instant-delete-btn')){
      const delBtn=document.createElement('button');
      delBtn.className='instant-delete-btn';
      delBtn.innerHTML='ğŸ—‘ Ø­Ø°Ù ÙÙˆØ±ÙŠ';
      delBtn.onclick=()=>showConfirmModal('Ù‡Ù„ ØªØ±ØºØ¨ ÙÙŠ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ØªÙ‚ÙÙŠÙ„Ø© ÙÙˆØ±Ù‹Ø§ØŸ',()=>deleteWithFlash(row,i+1));
      box.appendChild(delBtn);
    }
  });
});
</script>
<style>
/* ğŸ’¡ v7.18 - ØªØ¹Ø¯ÙŠÙ„ Ø­Ø³Ø¨ Ø·Ù„Ø¨ Ø§Ù„ØµÙˆØ±Ø©: Ø²Ø± Ø§Ù„Ø­Ø°Ù ÙÙŠ Ø¹Ù…ÙˆØ¯ "Ù…" */
.admin-delete-cell {
  position: relative;
}
.admin-delete-btn-id {
  background: rgba(239, 68, 68, 0.25);
  border: 1px solid rgba(239, 68, 68, 0.5);
  color: #ef4444;
  border-radius: 6px;
  padding: 4px 8px;
  font-family: 'Tajawal', sans-serif;
  font-size: 11.5px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.25s ease;
  display: inline-block;
  margin-top: 5px; /* Ù„Ø¥Ø¹Ø·Ø§Ø¡ Ù…Ø³Ø§ÙØ© Ù…Ù† Ø±Ù‚Ù… Ø§Ù„ØµÙ */
}
.admin-delete-btn-id:hover {
  background: rgba(239, 68, 68, 0.45);
  color: #fff;
  transform: scale(1.05);
}
/* ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø£ØµÙ„ÙŠ Ù„Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ© */
.final-info { 
  padding-bottom: 8px; /* Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø²Ø§Ø¦Ø¯Ø© */
}
.instant-delete-btn {
  display: none !important; /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø²Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø±Ø¨Ø¹ */
}

/* --- (Ù†Ù‡Ø§ÙŠØ© ØªØ¹Ø¯ÙŠÙ„Ø§Øª v7.18) --- */

.deleted-placeholder {
  background: transparent;
  border: 1px dashed rgba(245,197,66,0.4);
  color: #f5c542;
  font-family: 'Tajawal', sans-serif;
  font-size: 14px;
  text-align: center;
  padding: 10px;
  border-radius: 8px;
  opacity: 1;
  transition: opacity 1s ease;
}
.deleted-placeholder.fade-out { opacity: 0; }
@keyframes goldFlash { from { box-shadow: 0 0 20px rgba(245,197,66,0.8); } to { box-shadow: none; } }
.gold-flash { animation: goldFlash 0.5s ease; }

.row-fade-in { animation: fadeInRow 0.8s ease both; }
@keyframes fadeInRow { from { opacity:0; transform:scale(0.98); } to { opacity:1; transform:scale(1); } }

</style>

<script>
function isAdminUser(){
  const user=(localStorage.getItem('username')||localStorage.getItem('currentUser')||localStorage.getItem('loggedUser')||storedEmployeeName||'').toLowerCase();
  return user.includes('ayman777adam');
}

function getCurrentTime(){
  const now=new Date();
  return now.toLocaleTimeString('ar-EG',{hour:'2-digit',minute:'2-digit',hour12:false});
}

function deleteWithFlash(row, recordId, btn){
  if(btn){ btn.disabled=true; btn.textContent='Ø¬Ø§Ø±Ù Ø§Ù„Ø­Ø°Ù...'; btn.style.opacity='0.7'; }
  row.classList.add('gold-flash');
  setTimeout(()=>{
    const table=row.parentElement;
    if(table){
      const placeholder=document.createElement('tr');
      const cell=document.createElement('td');
      cell.colSpan=row.cells.length;
      const time=getCurrentTime();
      // ğŸ’¡ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: ØªÙ… Ø§Ù„Ø­Ø°Ù ÙÙ‰ Ø§Ù„ÙˆÙ‚Øª Ùˆ Ø§Ù„ØªØ§Ø±ÙŠØ®
      cell.innerHTML=`âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„ØµÙ Ø¨Ù†Ø¬Ø§Ø­ Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ø£Ø¯Ù…Ù† â€“ ${time}`;
      placeholder.className='deleted-placeholder';
      placeholder.appendChild(cell);
      table.insertBefore(placeholder,row);
      // Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ ÙØ¹Ù„ÙŠØ§Ù‹ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
      if(typeof deleteRecord==='function'){ deleteRecord(parseInt(recordId)); } 
      setTimeout(()=>{ placeholder.classList.add('fade-out'); },4000);
      setTimeout(()=>{ placeholder.remove(); },5500);
    }
  },600);
}

function showConfirmModal(message,onConfirm){
  const overlay=document.createElement('div');overlay.className='confirm-overlay';
  const modal=document.createElement('div');modal.className='confirm-modal';
  modal.innerHTML=`<h3>âš ï¸ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</h3><p>${message||'Ù‡Ù„ ØªØ±ØºØ¨ ÙÙŠ ØªÙ†ÙÙŠØ° Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ØŸ'}</p>
  <div class='confirm-btns'><button class='btn-cancel'>Ø¥Ù„ØºØ§Ø¡</button><button class='btn-confirm'>ØªØ£ÙƒÙŠØ¯</button></div>`;
  overlay.appendChild(modal);document.body.appendChild(overlay);
  overlay.addEventListener('click',e=>{if(e.target===overlay)overlay.remove();});
  modal.querySelector('.btn-cancel').onclick=()=>overlay.remove();
  modal.querySelector('.btn-confirm').onclick=()=>{overlay.remove();if(typeof onConfirm==='function')onConfirm();};
}

// âœ… ğŸ’¡ v7.18: Add delete button to 'ID' column (cell[0])
function addAdminButtons(){
  if(!isAdminUser()) return;
  
  // ğŸ’¡ ØªØ¹Ø¯ÙŠÙ„ v7.18: Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ù…ØºÙ„Ù‚Ø©
  document.querySelectorAll('tr.closed-row').forEach((row)=>{
    const idCell = row.cells[0]; // ğŸ’¡ Ø§Ø³ØªÙ‡Ø¯Ø§Ù Ø§Ù„Ø®Ù„ÙŠØ© "Ù…"
    if (!idCell || idCell.querySelector('.admin-delete-btn-id')) {
      return; // ğŸ’¡ ØªØ®Ø·ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø²Ø± Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§ Ø¨Ø§Ù„ÙØ¹Ù„
    }

    const recordId = row.dataset.recordId;
    const btn=document.createElement('button');
    btn.className='admin-delete-btn-id'; // ğŸ’¡ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
    btn.innerHTML='ğŸ—‘ Ø­Ø°Ù'; // Ù†Øµ Ø£ØµØºØ±
    btn.onclick=(e)=>{
      e.stopPropagation(); // Ù…Ù†Ø¹ Ø£ÙŠ Ø£Ø­Ø¯Ø§Ø« Ø£Ø®Ø±Ù‰ Ø¹Ù„Ù‰ Ø§Ù„ØµÙ
      showConfirmModal('Ù‡Ù„ ØªØ±ØºØ¨ ÙÙŠ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ØªÙ‚ÙÙŠÙ„Ø© ÙÙˆØ±Ù‹Ø§ØŸ',()=>deleteWithFlash(row,recordId,btn));
    };
    
    idCell.appendChild(document.createElement('br')); // ÙØ§ØµÙ„
    idCell.appendChild(btn); // ğŸ’¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø²Ø± Ù„Ù„Ø®Ù„ÙŠØ© "Ù…"
    idCell.classList.add('admin-delete-cell'); // Ø¥Ø¶Ø§ÙØ© ÙƒÙ„Ø§Ø³ Ù„Ù„Ø®Ù„ÙŠØ©
  });
  
  // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Ø§Ø­ØªÙŠØ§Ø·ÙŠ)
  document.querySelectorAll('.instant-delete-btn').forEach(b => b.style.display = 'none');
}

// ğŸ’¡ [ØªØ¹Ø¯ÙŠÙ„ Ù…Ù† Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø³Ø§Ø¨Ù‚]
// Observe dynamic changes to ensure buttons always added
window.onload = function(){
  const notice=document.getElementById('adminNotice');if(notice)notice.remove();
  
  // Ù„Ø§ ØªÙ‚Ù… Ø¨Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ØŒ Ø§Ù†ØªØ¸Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
  // addAdminButtons(); 

  const observer = new MutationObserver(()=> {
    // ÙÙ‚Ø· Ù‚Ù… Ø¨ØªØ´ØºÙŠÙ„ Ù‡Ø°Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‚Ø¯ Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„Ù‡ Ø¨Ø§Ù„ÙØ¹Ù„
    if (storedEmployeeName && storedEmployeeName !== "ØºÙŠØ± Ù…Ø­Ø¯Ø¯") {
      addAdminButtons();
    }
  });
  try{
  const mb=document.getElementById('mainTableBody');
  const cc=document.getElementById('cashCalc');
  if(mb) observer.observe(mb, {subtree:true, childList:true, characterData:true});
  if(cc) observer.observe(cc, {subtree:true, childList:true, characterData:true});
}catch(e){ console.error(e); }

};

// ğŸŒ™ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„ÙˆØ¶Ø¹ÙŠÙ†
const themeToggle = document.getElementById('themeToggle');
const savedTheme = localStorage.getItem('theme') || 'dark';
document.body.dataset.theme = savedTheme;
themeToggle.textContent = savedTheme === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';

themeToggle.addEventListener('click', () => {
  const newTheme = document.body.dataset.theme === 'dark' ? 'light' : 'dark';
  document.body.dataset.theme = newTheme;
  localStorage.setItem('theme', newTheme);
  themeToggle.textContent = newTheme === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';
});

</script>
<script>
// ğŸ§¹ ØªØµÙÙŠØ± ÙƒØ§Ù…Ù„ Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø©
window.addEventListener("beforeunload", () => {
  localStorage.removeItem("activeRecordAutosave");
  document.getElementById("calcDisplay").value = "";
  const history = document.getElementById("calcHistory");
  if (history) history.innerHTML = "";
  document.getElementById("notesBox").value = "";
  document.querySelectorAll("#cashCalc td[contenteditable]").forEach(td => td.textContent = "");
});

// ğŸ§¹ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± C ÙŠÙ…Ø³Ø­ Ø£ÙŠØ¶Ù‹Ø§ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙˆØ³Ø¬Ù„ Ø§Ù„Ø­Ø§Ø³Ø¨Ø©
document.addEventListener("DOMContentLoaded", () => {
  const grid = document.querySelector("#basicCalc .calc-grid");
  const disp = document.getElementById("calcDisplay");
  grid.addEventListener("click", e => {
    if (e.target.dataset.k === "C") {
      disp.value = "";
      document.getElementById("notesBox").value = "";
      const history = document.getElementById("calcHistory");
      if (history) history.innerHTML = "";
    }
  });
});
</script><script>
// ğŸ§¹ Ù…Ø³Ø­ ÙÙˆØ±ÙŠ Ø¹Ù†Ø¯ Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¯Ø§Ø®Ù„ Ø£ÙŠ Ø®Ù„ÙŠØ© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ­Ø±ÙŠØ± (ÙŠØ´Ù…Ù„ Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)
// ÙŠØ³ØªØ®Ø¯Ù… Ø§Ù„ØªÙÙˆÙŠØ¶ Ø¹Ù„Ù‰ document Ù„ÙŠØ¹Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªÙŠ ØªÙÙ†Ø´Ø£ Ù„Ø§Ø­Ù‚Ù‹Ø§
document.addEventListener('focusin', (e) => {
  const el = e.target;
  // Ù†ØªØ£ÙƒØ¯ Ø£Ù†Ù‡Ø§ Ø®Ù„ÙŠØ© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ­Ø±ÙŠØ± Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø£Ùˆ Ø­Ø§Ø³Ø¨Ø© Ø§Ù„ÙƒØ§Ø´
  if (!el || !el.isContentEditable) return;
  const inEditableArea = el.closest('#mainTableBody, #cashCalc');
  if (!inEditableArea) return;

  // Ø§Ù…Ø³Ø­ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¯Ø§Ø¦Ù…Ù‹Ø§ Ø¹Ù†Ø¯ ÙƒÙ„ ØªØ±ÙƒÙŠØ²
  if (el.textContent !== '') {
    el.textContent = '';
    // Ø£Ø·Ù„Ù‚ Ø­Ø¯Ø« input Ù„ÙƒÙŠ ØªÙØ­Ø¯Ù‘Ø« Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø§Øª ÙˆØ§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
    try { el.dispatchEvent(new Event('input', { bubbles: true })); } catch(_) {}
  }
});
</script><script>
// ğŸ‘‘ Ù†Ø¸Ø§Ù… ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø£Ø¯Ù…Ù†: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ayman777adam ÙÙ‚Ø· Ù‡Ùˆ Ø§Ù„Ø£Ø¯Ù…Ù† (Ø¨Ø¯ÙˆÙ† ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±)
document.addEventListener('DOMContentLoaded', () => {

  // ğŸŸ¢ ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
  const startBtn = document.getElementById('startWorkBtn');
  if (startBtn) {
    startBtn.addEventListener('click', () => {
      const username = document.getElementById('username').value.trim().toLowerCase();

      if (username === 'ayman777adam') {
        // âœ… Ø£Ø¯Ù…Ù† Ø¨Ø¯ÙˆÙ† ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±
        localStorage.setItem('isLoggedIn', 'true');
        localStorage.setItem('userRole', 'admin');
      } else {
        // ğŸ‘¤ Ù…ÙˆØ¸Ù Ø¹Ø§Ø¯ÙŠ
        localStorage.setItem('isLoggedIn', 'true');
        localStorage.setItem('userRole', 'employee');
      }
    });
  }

  // ğŸ›¡ï¸ Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ø­Ø°Ù Ø¹Ù† ØºÙŠØ± Ø§Ù„Ø£Ø¯Ù…Ù†
  const hideDeleteForNonAdmins = () => {
    const role = localStorage.getItem('userRole');
    if (role !== 'admin') {
      document.querySelectorAll('.delete-row-btn').forEach(btn => btn.style.display = 'none');
    }
  };

  // ØªÙ†ÙÙŠØ° Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
  hideDeleteForNonAdmins();

  // ğŸ” Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¥Ù†Ø´Ø§Ø¡ ØµÙÙˆÙ Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙÙˆØ±ÙŠ
  const observer = new MutationObserver(() => hideDeleteForNonAdmins());
  const tableBody = document.querySelector('#mainTableBody');
  if (tableBody) observer.observe(tableBody, { childList: true, subtree: true });

});
</script>

<script>
// ğŸŸ¢ Ù†Ø¸Ø§Ù… Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ø²Ø¬Ø§Ø¬ÙŠØ© Ø§Ù„Ù…ÙˆØ­Ø¯
function glassAlert(message, icon='âš ï¸'){
  return new Promise(resolve=>{
    const modal=document.getElementById('glassModal');
    const iconEl=modal.querySelector('.glass-icon');
    const msgEl=modal.querySelector('.glass-message');
    const yesBtn=modal.querySelector('#glassConfirmYes');
    const noBtn=modal.querySelector('#glassConfirmNo');
    iconEl.textContent=icon;
    msgEl.textContent=message;
    yesBtn.textContent='Ù…ÙˆØ§ÙÙ‚';
    noBtn.style.display='none';
    modal.classList.add('show');
    yesBtn.onclick=()=>{ modal.classList.remove('show'); resolve(true); };
  });
}

function glassConfirm(message, icon='âš ï¸'){
  return new Promise(resolve=>{
    const modal=document.getElementById('glassModal');
    const iconEl=modal.querySelector('.glass-icon');
    const msgEl=modal.querySelector('.glass-message');
    const yesBtn=modal.querySelector('#glassConfirmYes');
    const noBtn=modal.querySelector('#glassConfirmNo');
    iconEl.textContent=icon;
    msgEl.textContent=message;
    yesBtn.textContent='Ù†Ø¹Ù…';
    noBtn.textContent='Ø¥Ù„ØºØ§Ø¡';
    noBtn.style.display='inline-block';
    modal.classList.add('show');
    yesBtn.onclick=()=>{ modal.classList.remove('show'); resolve(true); };
    noBtn.onclick=()=>{ modal.classList.remove('show'); resolve(false); };
  });
}

// Ø§Ø³ØªØ¨Ø¯Ø§Ù„ confirm() Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
window.confirm = async (msg) => await glassConfirm(msg);
window.alert = async (msg) => await glassAlert(msg);
</script>

<script>
// âœ¨ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ø²Ø¬Ø§Ø¬ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙÙ‚Ø·
function createGlassModal(){
  const modal=document.createElement('div');
  modal.id='glassModal';
  modal.style.display='none';
  modal.innerHTML=`
    <div class="glass-content">
      <div class="glass-icon">âš ï¸</div>
      <div class="glass-message"></div>
      <div class="glass-buttons">
        <button id="glassConfirmYes" class="btn-glass-primary">Ù…ÙˆØ§ÙÙ‚</button>
        <button id="glassConfirmNo" class="btn-glass-secondary">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>`;
  document.body.appendChild(modal);

  const style=document.createElement('style');
  style.innerHTML=`
#glassModal{
  position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
  background:rgba(0,0,0,.35); backdrop-filter:blur(6px);
  z-index:3000; opacity:0; pointer-events:none; transition:opacity .4s ease;
}
#glassModal.show{opacity:1; pointer-events:auto;}
.glass-content{
  min-width:300px; max-width:420px; padding:24px 22px; border-radius:18px;
  background:rgba(15,23,42,0.75);
  border:1px solid rgba(245,197,66,0.45);
  box-shadow:0 0 40px rgba(245,197,66,0.25), 0 0 8px rgba(0,194,255,0.15) inset;
  color:#fff; text-align:center; backdrop-filter:blur(14px);
  animation:glassPop .4s ease both;
}
@keyframes glassPop{from{opacity:0; transform:translateY(-20px)} to{opacity:1; transform:translateY(0)}}
.glass-icon{font-size:36px; margin-bottom:10px;}
.glass-message{font-weight:700; font-size:17px; margin-bottom:20px;}
.glass-buttons{display:flex; justify-content:center; gap:10px;}
.btn-glass-primary, .btn-glass-secondary{
  border:none; border-radius:12px; padding:8px 18px; font-weight:800; cursor:pointer; transition:.25s;
}
.btn-glass-primary{
  background:linear-gradient(135deg,#f5c542,#eab308); color:#1f2937; box-shadow:0 0 12px rgba(245,197,66,.3);
}
.btn-glass-primary:hover{transform:scale(1.05);}
.btn-glass-secondary{
  background:rgba(255,255,255,0.1); color:#fff; border:1px solid rgba(255,255,255,0.15);
}
.btn-glass-secondary:hover{background:rgba(255,255,255,0.18);}
  `;
  document.head.appendChild(style);

  window.glassAlert = (message, icon='âš ï¸') => new Promise(resolve=>{
    const iconEl=modal.querySelector('.glass-icon');
    const msgEl=modal.querySelector('.glass-message');
    const yesBtn=modal.querySelector('#glassConfirmYes');
    const noBtn=modal.querySelector('#glassConfirmNo');
    iconEl.textContent=icon; msgEl.textContent=message;
    yesBtn.textContent='Ù…ÙˆØ§ÙÙ‚'; noBtn.style.display='none';
    modal.classList.add('show'); modal.style.display='flex';
    yesBtn.onclick=()=>{ modal.classList.remove('show'); resolve(true); };
  });

  window.glassConfirm = (message, icon='âš ï¸') => new Promise(resolve=>{
    const iconEl=modal.querySelector('.glass-icon');
    const msgEl=modal.querySelector('.glass-message');
    const yesBtn=modal.querySelector('#glassConfirmYes');
    const noBtn=modal.querySelector('#glassConfirmNo');
    iconEl.textContent=icon; msgEl.textContent=message;
    yesBtn.textContent='Ù†Ø¹Ù…'; noBtn.textContent='Ø¥Ù„ØºØ§Ø¡'; noBtn.style.display='inline-block';
    modal.classList.add('show'); modal.style.display='flex';
    yesBtn.onclick=()=>{ modal.classList.remove('show'); resolve(true); };
    noBtn.onclick=()=>{ modal.classList.remove('show'); resolve(false); };
  });

  window.confirm = async (msg) => await glassConfirm(msg);
  window.alert = async (msg) => await glassAlert(msg);
}

// âœ¨ Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨ Ø²Ø¬Ø§Ø¬ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù…Ø¯Ø© Ø«Ø§Ù†ÙŠØªÙŠÙ†
function showWelcomeGlass(name){
  const welcome=document.createElement('div');
  welcome.id='welcomeGlass';
  welcome.style.cssText=`
    position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
    z-index:4000; backdrop-filter:blur(6px); background:rgba(0,0,0,0.3);
    animation:fadeIn .4s ease forwards;
  `;
  welcome.innerHTML=`<div style="padding:26px 28px; background:rgba(15,23,42,0.75); border:1px solid rgba(245,197,66,.45); border-radius:20px; box-shadow:0 0 25px rgba(245,197,66,.25); color:#fff; font-weight:800; font-size:18px; text-align:center;">ğŸ‰ Ù…Ø±Ø­Ø¨Ù‹Ø§ ${name}ØŒ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­ ğŸŒŸ</div>`;
  document.body.appendChild(welcome);
  setTimeout(()=>{
    welcome.style.animation='fadeOut .5s ease forwards';
    setTimeout(()=>welcome.remove(),800);
  },2000);
}

// ğŸ”¹ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„
document.addEventListener('DOMContentLoaded', ()=>{
  const startBtn=document.getElementById('startWorkBtn');
  if(startBtn){
    startBtn.addEventListener('click', ()=>{
      setTimeout(()=>{
        createGlassModal();
        const name=document.getElementById('employeeNameInput').value.trim()||'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…';
        showWelcomeGlass(name);
      }, 800);
    });
  }
});
</script>

<script>
// ğŸŒ— Ù†Ø¸Ø§Ù… Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ ÙˆØ§Ù„Ù†Ù‡Ø§Ø±ÙŠ (ÙŠØ¯ÙˆÙŠ Ù…Ø¹ Ø­ÙØ¸ Ø§Ù„ØªÙØ¶ÙŠÙ„)
document.addEventListener('DOMContentLoaded', () => {
  const themeToggle = document.getElementById('themeToggle');
  const body = document.body;
  const savedTheme = localStorage.getItem('themeMode');
  if (savedTheme === 'light') {
    body.classList.add('light-mode');
    themeToggle.textContent = 'â˜€ï¸';
  }

  themeToggle.addEventListener('click', () => {
    body.classList.toggle('light-mode');
    const isLight = body.classList.contains('light-mode');
    localStorage.setItem('themeMode', isLight ? 'light' : 'dark');
    themeToggle.textContent = isLight ? 'â˜€ï¸' : 'ğŸŒ™';
  });
});
</script>

<!-- Embedded encrypted backup (DO NOT EDIT) -->
<script id="backupData" type="application/json">W10=</script>

<script>
// Embedded backup system (encrypted, client-side)
// Uses simple XOR + base64 obfuscation with dynamic key derived from storedEmployeeName.
// IMPORTANT: Browsers cannot overwrite the original HTML file on disk. Use "Ø­ÙØ¸ Ø§Ù„Ù†Ø³Ø®Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ù„Ù" button to download an updated HTML file containing the embedded backup.
(function(){
  const STORE_KEY = window.STORE_KEY || 'cashRegisterData';
  function getKey(){
    const base = (window.storedEmployeeName || 'user') + '_backup_key_2025';
    // reduce to reasonable length
    return base.slice(0, 32);
  }
  function xorBytes(inputBytes, keyBytes){
    const out = new Uint8Array(inputBytes.length);
    for(let i=0;i<inputBytes.length;i++){
      out[i] = inputBytes[i] ^ keyBytes[i % keyBytes.length];
    }
    return out;
  }
  function strToUtf8Bytes(str){
    return new TextEncoder().encode(str);
  }
  function utf8BytesToStr(bytes){
    return new TextDecoder().decode(bytes);
  }
  function b64encode(bytes){
    let binary = '';
    const len = bytes.byteLength;
    for(let i=0;i<len;i++) binary += String.fromCharCode(bytes[i]);
    return btoa(binary);
  }
  function b64decode(b64){
    const binary = atob(b64);
    const len = binary.length;
    const bytes = new Uint8Array(len);
    for(let i=0;i<len;i++) bytes[i] = binary.charCodeAt(i);
    return bytes;
  }
  function encryptJson(obj){
    try{
      const json = JSON.stringify(obj||[]);
      const key = strToUtf8Bytes(getKey());
      const data = strToUtf8Bytes(json);
      const xored = xorBytes(data, key);
      return b64encode(xored);
    }catch(e){ console.warn('encryptJson error', e); return ''; }
  }
  function decryptB64(b64){
    try{
      const key = strToUtf8Bytes(getKey());
      const data = b64decode(b64);
      const xored = xorBytes(data, key);
      return utf8BytesToStr(xored);
    }catch(e){ console.warn('decryptB64 error', e); return '[]'; }
  }

  // Read embedded backup (returns array)
  window.readEmbeddedBackup = function(){
    try{
      const el = document.getElementById('backupData');
      if(!el) return [];
      const enc = el.textContent.trim() || el.innerText.trim() || '';
      if(!enc) return [];
      const dec = decryptB64(enc);
      return JSON.parse(dec||'[]');
    }catch(e){ console.warn('readEmbeddedBackup parse error', e); return []; }
  };

  // Overwrite embedded backup in DOM (does not change file on disk)
  window.updateEmbeddedBackupDOM = function(records){
    try{
      const el = document.getElementById('backupData');
      if(!el) return false;
      const enc = encryptJson(records);
      el.textContent = enc;
      return true;
    }catch(e){ console.warn('updateEmbeddedBackupDOM error', e); return false; }
  };

  // Create downloadable HTML with updated embedded backup (user must save file to make it permanent)
  window.downloadHtmlWithEmbeddedBackup = function(filename){
    try{
      const el = document.getElementById('backupData');
      if(!el) return false;
      // ensure DOM backup is current
      const records = JSON.parse(localStorage.getItem(STORE_KEY) || '[]') || [];
      updateEmbeddedBackupDOM(records);
      const html = '<!doctype html>\\n' + document.documentElement.outerHTML;
      const blob = new Blob([html], {type:'text/html;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename || 'BOX-final-2-mod-with-backup.html';
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 1500);
      return true;
    }catch(e){ console.warn('downloadHtmlWithEmbeddedBackup error', e); return false; }
  };

  // Hook saving points to update DOM backup automatically (does not write file)
  function safeUpdateDOMBackup(){
    try{
      const records = JSON.parse(localStorage.getItem(STORE_KEY) || '[]') || [];
      updateEmbeddedBackupDOM(records);
    }catch(e){ console.warn('safeUpdateDOMBackup error', e); }
  }

  // Attach to existing save/delete points if present
  // Try to wrap local functions by polling
  function tryAttach(){
    // call once at load
    safeUpdateDOMBackup();
    // observe localStorage changes (best-effort)
    window.addEventListener('storage', safeUpdateDOMBackup);
    // also override localStorage.setItem to detect changes in same tab
    const origSet = localStorage.setItem;
    localStorage.setItem = function(k,v){
      try{ origSet.apply(this, arguments); }catch(e){}
      if(k===STORE_KEY) safeUpdateDOMBackup();
    };
  }
  tryAttach();

  // Create UI button in header for downloading updated HTML with embedded backup
  function ensureButton(){
    try{
      const header = document.querySelector('header .user-controls');
      if(!header) return;
      if(document.getElementById('saveEmbeddedBtn')) return;
      const btn = document.createElement('button');
      btn.id = 'saveEmbeddedBtn';
      btn.className = 'btn btn-gold';
      btn.style.marginLeft='8px';
      btn.title = 'Ø­ÙØ¸ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ù„Ù ÙˆØªÙ†Ø²ÙŠÙ„ Ù†Ø³Ø®Ø© HTML';
      btn.textContent = 'ğŸ“Š ';
      btn.onclick = function(){ window.open('','_blank'); };
      header.prepend(btn);
    }catch(e){ console.warn('ensureButton error', e); }
  }
  // Try to create the button after DOM ready
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', ensureButton);
  else ensureButton();

})(); // end IIFE
</script>
<!-- end embedded backup system -->

<script>
(async function(){
  const STORE_KEY = 'cashRegisterData';
  const SERVER = 'http://127.0.0.1:5005';

  async function loadFromServer(){
    try{
      const r = await fetch(SERVER + '/records');
      if(!r.ok) return;
      const data = await r.json();
      if(Array.isArray(data)){
        localStorage.setItem(STORE_KEY, JSON.stringify(data));
      }
    }catch(e){}
  }

  async function saveToServer(){
    try{
      const data = JSON.parse(localStorage.getItem(STORE_KEY)||"[]");
      await fetch(SERVER+'/records',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(data)
      });
    }catch(e){}
  }

  await loadFromServer();
  setInterval(saveToServer, 5000);
})();
</script>

<script>
(function(){
  const STORE_KEY='cashRegisterData';
  const SERVER='http://127.0.0.1:5005';
  const SYNC_INTERVAL=5000; // periodic sync
  let serverOnline=false;
  let saveQueue=[]; // queue of data to send
  let saving=false;
  let debounceTimer=null;

  const serverStatusEl = document.getElementById('serverStatus');
  const toastEl = document.getElementById('toast');
  const toastBox = document.getElementById('toastBox');

  function showMiniToast(msg, brief=true){
    if(!toastEl) return;
    toastBox.textContent = msg;
    toastEl.style.display='flex';
    if(debounceTimer) clearTimeout(debounceTimer);
    debounceTimer = setTimeout(()=>{ toastEl.style.display='none'; }, brief?1800:3200);
  }

  function setServerStatus(online){
    serverOnline = online;
    if(serverStatusEl){
      serverStatusEl.textContent = online ? 'ğŸŸ¢ Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…' : 'ğŸ”´ ØºÙŠØ± Ù…ØªØµÙ„ â€” Ø§Ù„Ø¹Ù…Ù„ Ù…Ø­Ù„ÙŠØ§Ù‹';
      serverStatusEl.style.color = online ? '#7ef59a' : '#ffb4b4';
    }
    // also update lastUpdate small text
    const lastUpdate = document.getElementById('lastUpdate');
    if(lastUpdate){
      const now = new Date();
      lastUpdate.textContent = (online ? 'ğŸŸ¢ Ø¢Ø®Ø± Ù…Ø²Ø§Ù…Ù†Ø©: ' : 'âš ï¸ ØªØ¹Ù…Ù„ Ù…Ø­Ù„ÙŠØ§Ù‹ Ù…Ù†Ø°: ') + now.toLocaleString('ar-EG');
    }
  }

  async function tryLoadFromServer(){
    try{
      const r = await fetch(SERVER + '/records', {cache:'no-store', mode:'cors'});
      if(!r.ok) throw new Error('no');
      const data = await r.json();
      if(Array.isArray(data)){
        // merge smart: server authoritative, but preserve any local records not present
        const local = JSON.parse(localStorage.getItem(STORE_KEY)||'[]');
        const byId = {};
        data.forEach(d=> byId[d.id]=d);
        local.forEach(l=>{
          if(!byId[l.id]) data.push(l); // keep local-only
        });
        localStorage.setItem(STORE_KEY, JSON.stringify(data));
        setServerStatus(true);
        showMiniToast('âœ… ØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…');
        return true;
      }
    }catch(e){
      setServerStatus(false);
      return false;
    }
  }

  async function pushToServer(payload){
    try{
      const r = await fetch(SERVER + '/records', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if(!r.ok) throw new Error('post failed');
      setServerStatus(true);
      showMiniToast('ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…', true);
      return true;
    }catch(e){
      setServerStatus(false);
      return false;
    }
  }

  // smart save: merges and queues
  function scheduleSave(immediate=false){
    if(debounceTimer) clearTimeout(debounceTimer);
    debounceTimer = setTimeout(async ()=>{
      const data = JSON.parse(localStorage.getItem(STORE_KEY)||'[]') || [];
      // always keep local copy
      try{ localStorage.setItem(STORE_KEY, JSON.stringify(data)); }catch(e){}
      if(serverOnline || immediate){
        const ok = await pushToServer(data);
        if(!ok){
          // queue for later
          saveQueue.push(JSON.stringify(data));
        }
      }else{
        saveQueue.push(JSON.stringify(data));
      }
    }, immediate?50:900);
  }

  // periodic sync tries to flush queue
  async function periodicSync(){
    if(saving) return;
    saving=true;
    try{
      // first, try to load if never online
      if(!serverOnline){
        await tryLoadFromServer();
      }
      // flush queue
      while(saveQueue.length>0){
        const item = JSON.parse(saveQueue.shift());
        const ok = await pushToServer(item);
        if(!ok){
          // push back and stop
          saveQueue.unshift(JSON.stringify(item));
          break;
        }
      }
    }finally{ saving=false; }
  }

  // observe LocalStorage changes from within the same tab
  (function overrideSetItem(){
    const orig = localStorage.setItem;
    localStorage.setItem = function(k,v){
      orig.apply(this, arguments);
      if(k===STORE_KEY){
        scheduleSave(true);
      }
    };
  })();

  // initial attempt to load
  tryLoadFromServer().then(()=>{ setInterval(periodicSync, SYNC_INTERVAL); });

  // silent save on unload to minimize data loss
  window.addEventListener('beforeunload', function(){
    try{
      const data = JSON.parse(localStorage.getItem(STORE_KEY)||'[]');
      // fire-and-forget synchronous send via navigator.sendBeacon if available
      if(navigator.sendBeacon){
        navigator.sendBeacon(SERVER + '/records', JSON.stringify(data));
      }else{
        // fallback: write localStorage only
        localStorage.setItem(STORE_KEY, JSON.stringify(data));
      }
    }catch(e){}
  });

  // expose API for other scripts of the system
  window.syncToServerNow = function(){
    try{ const data = JSON.parse(localStorage.getItem(STORE_KEY)||'[]'); pushToServer(data); }catch(e){}
  };
  window.setServerStatus = setServerStatus;
  window.scheduleSave = scheduleSave;

  // small heartbeat to update status text even if server unresponsive
  setInterval(()=>{ if(!serverOnline) serverStatusEl && (serverStatusEl.textContent = 'ğŸ”´ ØºÙŠØ± Ù…ØªØµÙ„ â€” Ø§Ù„Ø¹Ù…Ù„ Ù…Ø­Ù„ÙŠØ§Ù‹'); }, 7000);

})();
</script>

<script>
// --- A + C Protection Layer ---
(function(){
  const KEY = 'cashRegisterData';
  const BACK = 'cashRegisterBackup';

  // Create backup copy frequently
  function shadowCopy(){
    try{
      const data = localStorage.getItem(KEY);
      if(data) localStorage.setItem(BACK, data);
    }catch(e){}
  }
  setInterval(shadowCopy, 2000);

  // Restore if empty or corrupted
  function restoreIfNeeded(){
    try{
      const main = localStorage.getItem(KEY);
      if(!main || main === "[]" || main === null){
        const backup = localStorage.getItem(BACK);
        if(backup){
          localStorage.setItem(KEY, backup);
        }
      }
    }catch(e){}
  }
  restoreIfNeeded();

  // on reload safety
  window.addEventListener('beforeunload', ()=>{
    shadowCopy();
  });

})();
</script>

<script>
// --- File Signature Verification ---
(function(){
  const sig = document.querySelector('meta[name="system-signature"]');
  if(!sig || sig.content !== "AYMAN-SAFE-PROTECTED-2025"){
    alert("âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…Ø¹ØªÙ…Ø¯ â€” ØªÙ… Ù…Ù†Ø¹ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
    document.body.innerHTML = "<h2 style='color:red;text-align:center;margin-top:40px'>Ù…Ù„Ù ØºÙŠØ± Ù…Ø¹ØªÙ…Ø¯</h2>";
  }
})();
</script>

<script>
// Filter integration: uses existing saveQueue variable from page
(function(){
  function safeParseDateISO(d){
    if(!d) return null;
    var dt = new Date(d);
    if(isNaN(dt)) return null;
    return dt;
  }

  function formatISODate(d){
    var dt = new Date(d);
    if(isNaN(dt)) return '';
    var yyyy = dt.getFullYear();
    var mm = ('0'+(dt.getMonth()+1)).slice(-2);
    var dd = ('0'+dt.getDate()).slice(-2);
    return yyyy + '-' + mm + '-' + dd;
  }

  function populateEmployeeFilter(){
    try{
      if(!sel) return;
      sel.innerHTML = '<option value=\"\">-- ÙƒÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† --</option>';
      var seen = {};
      var arr = window.saveQueue || [];
      arr.forEach(function(r){
        var name = r.employee || r.emp || r.username || r.user || '';
        if(!name) return;
        if(seen[name]) return;
        seen[name]=1;
        var opt = document.createElement('option');
        opt.value = name; opt.textContent = name;
        sel.appendChild(opt);
      });
    }catch(e){console.error(e);}
  }

  function applyFilters(){
    try{
      var arr = window.saveQueue || [];
      var now = Date.now();
      var filtered = arr.filter(function(r){
        // closed only and pass 30s
        var closedField = r.closeTime || r.closedTime || r['Ø§Ù„ØªØ§Ø±ÙŠØ®/ÙˆÙ‚Øª Ø§Ù„Ø¥ØºÙ„Ø§Ù‚'] || r['closeTime'];
        if(!closedField) return false;
        var dt = new Date(closedField);
        if(isNaN(dt)) return false;
        if(now - dt.getTime() < 30000) return false;
        if(emp && ( (r.employee||r.emp||r.user||'') !== emp)) return false;
        if(dateVal){
          var dISO = formatISODate(dt);
          if(dISO !== dateVal) return false;
        }
        return true;
      });
      // call existing function that rebuilds table if exists, else build manually
      if(typeof buildTable === 'function'){
        try{ buildTable(filtered); return; }catch(e){/*fallback*/ }
      }
      // fallback: find table body and render minimal rows
      var tbody = document.querySelector('#resultsTable tbody') || document.querySelector('table tbody');
      if(!tbody) return;
      tbody.innerHTML = '';
      filtered.forEach(function(r,i){
        var tr = document.createElement('tr');
        tr.innerHTML = '<td>'+(i+1)+'</td>'
          +'<td>'+(r.employee||r.emp||'')+'</td>'
          +'<td>'+(r.closeTime||r['Ø§Ù„ØªØ§Ø±ÙŠØ®/ÙˆÙ‚Øª Ø§Ù„Ø¥ØºÙ„Ø§Ù‚']||'')+'</td>'
          +'<td>'+(r.cash||0)+'</td>'
          +'<td>'+(r.visa||0)+'</td>'
          +'<td>'+(r.expense||0)+'</td>'
          +'<td>'+(r.treasuryReserve||0)+'</td>'
          +'<td>'+(r.notes||'')+'</td>';
        tbody.appendChild(tr);
      });
    }catch(e){console.error(e);}
  }

  // wire events
  document.addEventListener('DOMContentLoaded', function(){
    populateEmployeeFilter();
      applyFilters();
    });
    // also populate periodically in case saveQueue changes
    setInterval(populateEmployeeFilter, 2000);
  });
})();
</script>

<script>
// Utilities
function to24(h, m, ap){
  h = parseInt(h) || 0; m = parseInt(m) || 0;
  if(ap === 'Ù…' && h < 12) h += 12;
  if(ap === 'Øµ' && h === 12) h = 0;
  return {h:m= m, hh:h, mm:m};
}
function pad(n){ return (n<10? '0'+n : ''+n); }
function getDateTimeFromControls(dateStr, hourStr, minStr, ap){
  if(!dateStr) return null;
  var d = new Date(dateStr + 'T00:00:00');
  var h = parseInt(hourStr) || 0;
  var m = parseInt(minStr) || 0;
  if(ap === 'Ù…' && h < 12) h += 12;
  if(ap === 'Øµ' && h === 12) h = 0;
  d.setHours(h, m, 0, 0);
  return d;
}

// Populate employee options from saveQueue
function populateEmployees(){
  try{
    var sel = document.getElementById('fltEmployee');
    if(!sel) return;
    var arr = window.saveQueue || [];
    var seen = {};
    sel.innerHTML = '<option value="">-- ÙƒÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† --</option>';
    arr.forEach(function(r){
      var name = r.employee || r.emp || r.user || r.username || '';
      if(!name) return;
      if(seen[name]) return;
      seen[name]=1;
      var o = document.createElement('option'); o.value = name; o.textContent = name; sel.appendChild(o);
    });
  }catch(e){console.error(e);}
}

// Numeric-only filter allowing Arabic and English digits
function normalizeDigits(){
  try{ if(arguments[0] && arguments[0].id==='notesBox') return arguments[0].value || arguments[0].textContent || ''; }catch(e){}

  if(!s && s!==0) return '';
  s = s.toString();
  // convert arabic-Indic digits to Latin
  var map = {'Ù ':'0','Ù¡':'1','Ù¢':'2','Ù£':'3','Ù¤':'4','Ù¥':'5','Ù¦':'6','Ù§':'7','Ù¨':'8','Ù©':'9'};
  s = s.replace(/[Ù -Ù©]/g, function(d){ return map[d]; });
  // remove non-digits
  s = s.replace(/[^\d]/g,'');
  return s;
}

function enforceNumericInput(e){
  var allowed = ['Backspace','Delete','ArrowLeft','ArrowRight','Tab'];
  if(allowed.indexOf(e.key) !== -1) return;
  var ch = e.key;
  // allow digits (0-9) and arabic digits
  if(/^[0-9]$/.test(ch)) return;
  if(/^[\u0660-\u0669]$/.test(ch)) return;
  e.preventDefault();
}

// Apply filters to saveQueue and rebuild table
function applyAdvancedFilter(){
  try{
    var arr = window.saveQueue || [];
    var emp = document.getElementById('fltEmployee').value || '';
    var fromDate = document.getElementById('fltFromDate').value || '';
    var toDate = document.getElementById('fltToDate').value || '';
    var fromHour = document.getElementById('fltFromHour').value || '';
    var fromMin = document.getElementById('fltFromMin').value || '';
    var fromAP = document.getElementById('fltFromAP').value || 'Øµ';
    var toHour = document.getElementById('fltToHour').value || '';
    var toMin = document.getElementById('fltToMin').value || '';
    var toAP = document.getElementById('fltToAP').value || 'Ù…';
    var now = Date.now();

    var fromDT = getDateTimeFromControls(fromDate, fromHour, fromMin, fromAP);
    var toDT = getDateTimeFromControls(toDate, toHour, toMin, toAP);
    // if toDT exists, set to end of minute
    if(toDT) toDT.setSeconds(59);

    var filtered = arr.filter(function(r){
      // closed check
      var closeField = r.closeTime || r.closedTime || r['Ø§Ù„ØªØ§Ø±ÙŠØ®/ÙˆÙ‚Øª Ø§Ù„Ø¥ØºÙ„Ø§Ù‚'] || r['closeTime'];
      if(!closeField) return false;
      var dt = new Date(closeField);
      if(isNaN(dt)) return false;
      // passed 30s
      if(now - dt.getTime() < 30000) return false;
      // employee
      if(emp){
        var name = r.employee || r.emp || r.user || r.username || '';
        if(name !== emp) return false;
      }
      // date range
      if(fromDT && dt < fromDT) return false;
      if(toDT && dt > toDT) return false;
      return true;
    });

    // sort by close time desc
    filtered.sort(function(a,b){
      var at = new Date(a.closeTime || a.closedTime || a['Ø§Ù„ØªØ§Ø±ÙŠØ®/ÙˆÙ‚Øª Ø§Ù„Ø¥ØºÙ„Ø§Ù‚'] || a['closeTime']);
      var bt = new Date(b.closeTime || b.closedTime || b['Ø§Ù„ØªØ§Ø±ÙŠØ®/ÙˆÙ‚Øª Ø§Ù„Ø¥ØºÙ„Ø§Ù‚'] || b['closeTime']);
      return bt - at;
    });

    // update count
    document.getElementById('fltCount').textContent = filtered.length;

    // call existing rebuild if exists
    if(typeof buildTable === 'function'){
      try{ buildTable(filtered); return; }catch(e){}
    }
    // fallback: minimal rebuild
    var tbody = document.querySelector('#resultsTable tbody') || document.querySelector('table tbody');
    if(!tbody) return;
    tbody.innerHTML = '';
    filtered.forEach(function(r,i){
      var tr = document.createElement('tr');
      tr.innerHTML = '<td>'+(i+1)+'</td>'
        +'<td>'+(r.employee||r.emp||'')+'</td>'
        +'<td>'+(r.closeTime || r.closedTime || r['Ø§Ù„ØªØ§Ø±ÙŠØ®/ÙˆÙ‚Øª Ø§Ù„Ø¥ØºÙ„Ø§Ù‚'] || '')+'</td>'
        +'<td>'+(r.cash||0)+'</td>'
        +'<td>'+(r.visa||0)+'</td>'
        +'<td>'+(r.expense||0)+'</td>'
        +'<td>'+(r.treasuryReserve||0)+'</td>'
        +'<td>'+(r.notes||'')+'</td>';
      tbody.appendChild(tr);
    });
  }catch(e){console.error(e);}
}

function resetFilters(){
  document.getElementById('fltEmployee').value='';
  document.getElementById('fltFromDate').value='';
  document.getElementById('fltFromHour').value='';
  document.getElementById('fltFromMin').value='';
  document.getElementById('fltFromAP').value='Øµ';
  document.getElementById('fltToDate').value='';
  document.getElementById('fltToHour').value='';
  document.getElementById('fltToMin').value='';
  document.getElementById('fltToAP').value='Ù…';
  applyAdvancedFilter();
}

// wire events
document.addEventListener('DOMContentLoaded', function(){
  // attach numeric enforcement to hour/min inputs
  ['fltFromHour','fltFromMin','fltToHour','fltToMin'].forEach(function(id){
    var el = document.getElementById(id);
    if(!el) return;
    el.addEventListener('keydown', function(e){ if(e && e.target && (e.target.id==='notesBox' || e.target.tagName==='TEXTAREA')) return; enforceNumericInput(e); });
    el.addEventListener('input', function(e){
      var v = normalizeDigits(this.value);
      this.value = v;
    });
  });
  document.getElementById('fltApply').addEventListener('click', applyAdvancedFilter);
  document.getElementById('fltReset').addEventListener('click', resetFilters);
  // populate employees periodically
  populateEmployees();
  setInterval(populateEmployees, 2000);
});
</script>


<!-- Injected: remove report buttons and enforce numeric-only inputs/contenteditable -->
<style>
/* Hide browser-introduced print/report overlays if any */
button[onclick*="print"], button[title*="Print"], button[aria-label*="Print"] { display: none !important; }
/* Extra: hide any small square icon buttons that may represent report shortcuts (defensive) */
button.icon-report, .icon-report { display: none !important; }
</style>
<script>
(function(){
  function removeReportButtons(){
    const keys = ['ğŸ“Š','ØªÙ‚Ø±ÙŠØ±','ØªÙ‚Ø§Ø±ÙŠØ±','Report','Reports','ØªÙ‚Ø§Ø±ÙŠØ±'];
    document.querySelectorAll('button').forEach(b=>{
      try{
        const t = (b.innerText||'').trim();
        const title = (b.title||'').trim();
        if(keys.some(k=>t.includes(k) || title.includes(k))){
          b.remove();
          return;
        }
        // defensive: remove by id/class names commonly used
        const id = (b.id||'').toLowerCase();
        const cls = (b.className||'').toLowerCase();
        if(id.includes('report')||cls.includes('report')||id.includes('reports')||cls.includes('reports')){
          b.remove();
          return;
        }
        // remove tiny standalone emoji-only buttons with square-like glyphs (defensive)
        if(/^[\u{1F300}-\u{1F6FF}\s]{1,3}$/u.test(t) && b.getBoundingClientRect().width<48){
          // if it contains chart-like emoji specifically
          if(t.includes('ğŸ“Š')||t.includes('ğŸ“ˆ')||t.includes('ğŸ“‰')) b.remove();
        }
      }catch(e){}
    });
  }

  function enforceNumericOnInputs(){
    // allow digits, dot and minus for calculator fields; remove Arabic and Latin letters
    const letterRegex = /[A-Za-z\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF]/g;
    const nonAllowedInNumeric = /[^0-9.\-]/g; // allow digits, dot and minus
    document.querySelectorAll('input, textarea').forEach(inp=>{
    if(inp.id==='employeeNameInput') return;
      if(inp.id==='notesBox') return; // skip notesBox
      inp.addEventListener('input', ()=>{
        // If input type=number browsers may block but sanitize anyway
        try{
          // For fields that likely are numeric (type=number or placeholders/ids containing keywords)
          const name = (inp.name||'') + ' ' + (inp.id||'') + ' ' + (inp.className||'') + ' ' + (inp.placeholder||'');
          const isLikelyNumeric = inp.type==='number' || /cash|visa|master|card|mada|bank|program|expense|count|hour|min|time|total|amount|num|Ø±Ù‚Ù…|ÙƒØ§Ø´|Ù…Ø¬Ù…ÙˆØ¹|Ø³Ø§Ø¹/i.test(name);
          if(isLikelyNumeric){
            // remove letters and keep digits . - only
            const cleaned = (inp.value||'').replace(letterRegex, '').replace(nonAllowedInNumeric, '');
            if(cleaned !== inp.value) inp.value = cleaned;
          } else {
            // still remove only Arabic/Latin letters if user wants strictly numeric in some textareas? we leave non-numeric for others
          }
        }catch(e){}
      }, {passive:true});
      // block keypress of letters for extra safety
      inp.addEventListener('keypress', function(e){ if(inp.id==='employeeNameInput') return; , (ev)=>{
        if(ev && ev.target && (ev.target.id==='notesBox' || ev.target.tagName==='TEXTAREA')) return;
        const k = ev.key || '';
        if(/[A-Za-z\u0600-\u06FF]/.test(k)){
          ev.preventDefault();
        }
      });
    });
    // contenteditable cells in table (numeric cells)
    document.querySelectorAll('#mainTableBody td[contenteditable], #cashCalc td[contenteditable]').forEach(td=>{
      td.addEventListener('input', ()=>{
        const before = td.innerText;
        const cleaned = before.replace(/[A-Za-z\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF]/g, '').replace(/[^0-9.\-]/g, '');
        if(cleaned !== before) {
          // preserve caret by rewriting textContent
          td.innerText = cleaned;
        }
      });
      td.addEventListener('keypress', (ev)=>{
        if(ev && ev.target && (ev.target.id==='notesBox' || ev.target.tagName==='TEXTAREA')) return;
        const k = ev.key || '';
        if(/[A-Za-z\u0600-\u06FF]/.test(k)){
          ev.preventDefault();
        }
      });
      // prevent paste with letters
      td.addEventListener('paste', (ev)=>{
        ev.preventDefault();
        const text = (ev.clipboardData || window.clipboardData).getData('text') || '';
        const cleaned = text.replace(/[A-Za-z\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF]/g, '').replace(/[^0-9.\-]/g, '');
        document.execCommand('insertText', false, cleaned);
      });
    });
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    removeReportButtons();
    enforceNumericOnInputs();
    // also attempt again after short delay in case UI injected later
    setTimeout(removeReportButtons, 800);
    setTimeout(enforceNumericOnInputs, 800);
  });
  // Expose functions for debugging in console if needed
  window.__cleanupReports = removeReportButtons;
  window.__enforceNumeric = enforceNumericOnInputs;
})(); 
</script>
<!-- End injected -->


<script>
// Numeric-only filter for all numeric cells
const arabicToEnglish = s => s.replace(/[Ù -Ù©]/g, d => "Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©".indexOf(d));

function enforceNumeric(el){
  el.addEventListener('input', ()=>{
    let v = el.innerText;
    v = v.replace(/[^0-9Ù -Ù©]/g,'');
    el.innerText = v;
    const range = document.createRange();
    const sel = window.getSelection();
    range.selectNodeContents(el);
    range.collapse(false);
    sel.removeAllRanges();
    sel.addRange(range);
  });
}

function initNumericFilters(){
  document.querySelectorAll('td[contenteditable]').forEach(td=>{
    const notes = document.getElementById('notesBox');
    if(td!==notes){
      enforceNumeric(td);
    }
  });
  document.querySelectorAll('#cashCalc td[contenteditable]').forEach(td=> enforceNumeric(td));
}

document.addEventListener('DOMContentLoaded', initNumericFilters);
</script>


<script>
// Comprehensive numeric enforcement
function cleanValue(v){
  return v.replace(/[^0-9Ù -Ù©]/g,'');
}

function cleanAllNumeric(){
  // skip notesBox entirely
  document.querySelectorAll('td[contenteditable]').forEach(td=>{ if(td && td.id==='notesBox') return;
    let v = td.innerText;
    let nv = cleanValue(v);
    if(v !== nv) td.innerText = nv;
  });
  document.querySelectorAll('#cashCalc td[contenteditable]').forEach(td=>{
    let v = td.innerText;
    let nv = cleanValue(v);
    if(v !== nv) td.innerText = nv;
  });
}

const observer = new MutationObserver(cleanAllNumeric);
try{
  const mb=document.getElementById('mainTableBody');
  const cc=document.getElementById('cashCalc');
  if(mb) observer.observe(mb, {subtree:true, childList:true, characterData:true});
  if(cc) observer.observe(cc, {subtree:true, childList:true, characterData:true});
}catch(e){ console.error(e); }


// also run periodically
setInterval(cleanAllNumeric, 400);
</script>


<script id="themes-script">
(function(){
  const order = ['theme-peach','theme-sendpulse','theme-respondio','theme-neonblue','theme-g2','theme-javna'];
  let idx = 0;
  const btn = document.getElementById('themeToggle');
  if(!btn) return;
  // Load saved
  const saved = localStorage.getItem('selectedTheme');
  if(saved && order.includes(saved)){
    document.body.classList.remove(...order);
    document.body.classList.add(saved);
    idx = order.indexOf(saved);
  } else {
    document.body.classList.add(order[0]);
    localStorage.setItem('selectedTheme', order[0]);
    idx = 0;
  }

  // Tooltip small label
  function showTip(text){
    let tip = document.getElementById('themeToggleTip');
    if(!tip){
      tip = document.createElement('div'); tip.id='themeToggleTip';
      tip.style.position='fixed'; tip.style.right='20px'; tip.style.top='70px';
      tip.style.padding='8px 12px'; tip.style.borderRadius='10px'; tip.style.background='rgba(0,0,0,0.6)';
      tip.style.color='#fff'; tip.style.zIndex=99999; tip.style.fontSize='13px'; tip.style.opacity='0';
      tip.style.transition='opacity .25s ease, transform .25s ease';
      document.body.appendChild(tip);
    }
    tip.textContent = text;
    tip.style.opacity='1'; tip.style.transform='translateY(0)';
    clearTimeout(tip._t); tip._t = setTimeout(()=>{ tip.style.opacity='0'; tip.style.transform='translateY(-6px)'; }, 1400);
  }

  btn.addEventListener('click', ()=>{
    idx = (idx+1) % order.length;
    const cls = order[idx];
    document.body.classList.remove(...order);
    document.body.classList.add(cls);
    localStorage.setItem('selectedTheme', cls);
    showTip('Sime: ' + cls.replace('theme-',''));
    // small pulse
    btn.style.transform='scale(1.12)';
    setTimeout(()=>btn.style.transform='scale(1)',280);
  });

  // Allow long press to open quick menu (visual previews) - fallback: shift+click opens menu
  btn.addEventListener('contextmenu', function(e){ e.preventDefault(); openQuickMenu(); });

  function openQuickMenu(){
    // simple menu near button
    const menuId='themeQuickMenu';
    let menu = document.getElementById(menuId);
    if(menu){ menu.remove(); return; }
    menu = document.createElement('div'); menu.id=menuId;
    menu.style.position='fixed'; menu.style.right='20px'; menu.style.top='70px'; menu.style.background='rgba(0,0,0,0.75)';
    menu.style.padding='8px'; menu.style.borderRadius='10px'; menu.style.zIndex=99999; menu.style.display='grid'; menu.style.gap='6px';
    order.forEach((c, i)=>{
      const item=document.createElement('div');
      item.textContent = c.replace('theme-','');
      item.style.padding='8px 10px'; item.style.borderRadius='8px'; item.style.cursor='pointer';
      item.style.background='linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01))';
      item.onclick = ()=>{ document.body.classList.remove(...order); document.body.classList.add(c); localStorage.setItem('selectedTheme', c); menu.remove(); showTip(item.textContent); };
      menu.appendChild(item);
    });
    document.body.appendChild(menu);
    setTimeout(()=>{ document.addEventListener('click', ()=>menu.remove(), { once:true }); }, 50);
  }

})();
</script>


<!-- Update Uploader (Admin only) -->
<style id="uploader-style">
#uploaderBtn {
  position: fixed;
  top: 20px;
  right: 80px;
  z-index: 100000;
  width:44px; height:44px;
  display:inline-grid; place-items:center;
  border-radius:10px; cursor:pointer;
  background: linear-gradient(135deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
  box-shadow: 0 6px 18px rgba(0,0,0,0.25);
  font-size:18px;
}
#uploaderBtn.hidden { display:none !important; }
#uploaderStatus {
  position: fixed; right: 20px; top: 120px; z-index:100000; 
  padding:8px 12px; border-radius:8px; background:rgba(0,0,0,0.7); color:#fff; font-size:13px; display:none;
}
#uploaderModal {
  position: fixed; right: 50%; top: 50%; transform: translate(50%, -50%);
  z-index:100001; background: #111; color:#fff; padding:14px; border-radius:10px; display:none;
  width:360px; max-width:90%;
}
#uploaderModal input[type="file"]{ width:100%; }
#uploaderModal .row{ margin:8px 0; }
#uploaderModal .hint{ font-size:12px; color:#ddd; margin-top:6px; }
#uploaderModal button{ padding:8px 10px; border-radius:8px; cursor:pointer; }
</style>

<div id="uploaderBtn" title="ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥ØµØ¯Ø§Ø±">ğŸ”¼</div>
<div id="uploaderStatus"></div>

<div id="uploaderModal" role="dialog" aria-hidden="true">
  <div style="font-weight:700; margin-bottom:6px">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥ØµØ¯Ø§Ø± (Ù„Ù„Ù…Ø´Ø±Ù ÙÙ‚Ø·)</div>
  <div class="row">
    <label>Ø§Ø®ØªØ± Ù…Ù„Ù HTML Ø¬Ø¯ÙŠØ¯</label><br>
    <input id="uploaderFile" type="file" accept=".html" />
  </div>
  <div class="row">
    <label>Ø£Ø¯Ø®Ù„ GitHub Token (ÙŠÙØ®Ø²Ù† Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙÙ‚Ø·)</label><br>
    <input id="uploaderToken" type="password" style="width:100%" placeholder="ghp_xxx..." />
<label style="display:flex; align-items:center; gap:6px; margin-top:8px;"><input type="checkbox" id="rememberToken"><span>Ø­ÙØ¸ Ø§Ù„ØªÙˆÙƒÙ† (ÙŠÙØ®Ø²Ù† Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙÙ‚Ø·)</span></label>
    <div class="hint">Ù„Ø§ ØªØ´Ø§Ø±Ùƒ Ø§Ù„ØªÙˆÙƒÙ† Ù…Ø¹ Ø£ÙŠ Ø´Ø®Øµ. ÙŠÙØ®Ø²Ù† ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ ÙÙ‚Ø·.</div>
  </div>
  <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:10px">
    <button id="uploaderCancel">Ø¥Ù„ØºØ§Ø¡</button>
    <button id="uploaderSend" style="background:#1b95e0; color:#fff">Ø±ÙØ¹ ÙˆÙ†Ø´Ø±</button>
  </div>
  <div class="hint" style="margin-top:10px">Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ <strong>index.html</strong> ÙÙŠ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹: <span id="uploaderRepo">ayman777adam/cashbox-system</span></div>
</div>

<script id="uploader-script">
(function(){
  const ADMIN_USER = 'ayman777adam'; // admin username
  const REPO_USER = 'ayman777adam';
  const REPO_NAME = 'cashbox-system';
  const TARGET_PATH = 'index.html';

  const btn = document.getElementById('uploaderBtn');
  const status = document.getElementById('uploaderStatus');
  const modal = document.getElementById('uploaderModal');
  const fileInput = document.getElementById('uploaderFile');
  const tokenInput = document.getElementById('uploaderToken');
  const cancelBtn = document.getElementById('uploaderCancel');
  const sendBtn = document.getElementById('uploaderSend');

  function showStatus(msg, timeout){
    status.textContent = msg;
    status.style.display = 'block';
    clearTimeout(status._t);
    if(timeout) status._t = setTimeout(()=>status.style.display='none', timeout);
  }

  // show only if admin
  const currentUser = (localStorage.getItem('username') || '').toLowerCase();
  if(currentUser !== ADMIN_USER.toLowerCase()){
    btn.classList.add('hidden');
    return;
  }

  btn.addEventListener('click', ()=>{
    modal.style.display='block';
  });
  cancelBtn.addEventListener('click', ()=>{ modal.style.display='none'; });

  sendBtn.addEventListener('click', async ()=>{
    const f = fileInput.files && fileInput.files[0];
    const token = tokenInput.value.trim();
    if(!f){ showStatus('Ø§Ø®ØªØ± Ù…Ù„Ù HTML Ø£ÙˆÙ„Ø§Ù‹', 3000); return; }
    if(!token){ showStatus('Ø£Ø¯Ø®Ù„ GitHub Token', 3000); return; }
    showStatus('Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù...', 2000);

    const reader = new FileReader();
    reader.onload = async function(e){
      try {
        const contentText = e.target.result;
        // prepare base64
        const b64 = btoa(unescape(encodeURIComponent(contentText)));
        showStatus('Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù„Ù Ù…Ù† GitHub...', 2000);

        // get current sha
        const url = `https://api.github.com/repos/${REPO_USER}/${REPO_NAME}/contents/${TARGET_PATH}`;
        const res = await fetch(url, { headers: { Authorization: 'token ' + token } });
        if(res.status === 404){
          // file not exist - create new
          const payload = { message:'Auto Update - Web Uploader', content: b64 };
          const putRes = await fetch(url, { method:'PUT', headers: { Authorization: 'token ' + token, 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
          if(putRes.ok){ showStatus('ØªÙ… Ø§Ù„Ù†Ø´Ø± Ø¨Ù†Ø¬Ø§Ø­', 4000); modal.style.display='none'; } else { const txt = await putRes.text(); showStatus('ÙØ´Ù„ Ø§Ù„Ù†Ø´Ø±: '+putRes.status, 6000); console.error(txt); }
          return;
        }
        if(!res.ok){ const txt = await res.text(); showStatus('ÙØ´Ù„ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ù: '+res.status, 6000); console.error(txt); return; }
        const meta = await res.json();
        const sha = meta.sha;

        // confirm and put
        showStatus('Ø±ÙØ¹ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©...', 2000);
        const payload = { message: 'Auto Update - Web Uploader', content: b64, sha: sha };
        const put = await fetch(url, { method:'PUT', headers:{ Authorization: 'token ' + token, 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
        if(put.ok){
          showStatus('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¬Ø§Ø­ â€” Ø§Ù†ØªØ¸Ø± ØªØ­Ø¯ÙŠØ« GitHub Pages', 5000);
          modal.style.display='none';
        } else {
          const txt = await put.text();
          showStatus('ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«: '+put.status, 6000);
          console.error(txt);
        }
      } catch(err){
        console.error(err);
        showStatus('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø±ÙØ¹', 6000);
      }
    };
    reader.readAsText(f, 'utf-8');
  });

})();
</script>


<script>
document.addEventListener("DOMContentLoaded",()=>{
 const tokenInput=document.getElementById("uploaderToken");
 const remember=document.getElementById("rememberToken");
 if(!tokenInput||!remember)return;
 const saved=localStorage.getItem("github_token");
 if(saved){
   tokenInput.value=saved;
   remember.checked=true;
 }
 remember.addEventListener("change",()=>{
   if(remember.checked && tokenInput.value.trim()!==""){
     localStorage.setItem("github_token", tokenInput.value.trim());
   } else {
     localStorage.removeItem("github_token");
   }
 });
 tokenInput.addEventListener("input",()=>{
   if(remember.checked){
     localStorage.setItem("github_token", tokenInput.value.trim());
   }
 });
});
</script>

</body>
</html>
<style>
/* ğŸŒ¿ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ Ø§Ù„Ø±Ø³Ù…ÙŠ Ø§Ù„ÙØ®Ù… â€“ Royal Emerald Edition */
body.light-mode {
  --bg: #f9fafb;
  --bg2: #ffffffcc;
  --panel: rgba(255,255,255,0.95);
  --panel-strong: rgba(255,255,255,0.98);
  --border: #d1d5db;
  --text: #1e293b;
  --muted: #475569;
  --primary: #144d3a;
  --primary-2: #2f8a6b;
  --accent: #144d3a;
  --good: #15803d;
  --bad: #dc2626;

  background: var(--bg);
  color: var(--text);
  transition: background 0.6s ease, color 0.6s ease, filter 0.6s ease;
}

/* ğŸ§Š Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ÙˆØ§Ù„Ù„ÙˆØ­Ø§Øª */
body.light-mode .card,
body.light-mode header,
body.light-mode .metric-card {
  background: var(--panel);
  color: var(--text);
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  border: 1px solid var(--border);
  backdrop-filter: blur(8px);
}

/* ğŸ“Š Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
body.light-mode table {
  border-collapse: collapse;
  border: 1px solid var(--border);
  background-color: #f9fafb;
}
body.light-mode thead th {
  background-color: #e5e7eb;
  color: var(--text);
  font-weight: 800;
  border-bottom: 2px solid var(--border);
}
body.light-mode tbody tr:nth-child(even) {
  background-color: #ffffff;
}
body.light-mode tbody tr:nth-child(odd) {
  background-color: #f3f4f6;
}
body.light-mode td, body.light-mode th {
  border: 1px solid var(--border);
  color: var(--text);
}
body.light-mode td[contenteditable] {
  background: #ffffff;
  border: 1px solid var(--border);
  color: #1e293b;
}
body.light-mode td[contenteditable]:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 2px rgba(20,77,58,0.3) inset;
}

/* âœ¨ Ø§Ù„Ù†ØµÙˆØµ ÙˆØ§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† */
body.light-mode .brand-line,
body.light-mode .header-left .title {
  color: var(--accent);
}
body.light-mode .header-left .subtitle {
  color: var(--muted);
}
body.light-mode .last-update {
  color: var(--accent);
}

/* ğŸ”˜ Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
body.light-mode .btn-blue,
body.light-mode .btn-gold {
  background: linear-gradient(135deg, var(--primary-2), var(--primary));
  color: #fff;
  border: 1px solid var(--border);
  box-shadow: 0 3px 8px rgba(20,77,58,0.25);
}
body.light-mode .btn-blue:hover,
body.light-mode .btn-gold:hover {
  background: linear-gradient(135deg, #166c52, #0f3b2e);
  box-shadow: 0 0 10px rgba(20,77,58,0.3), 0 0 6px rgba(47,138,107,0.25) inset;
}
body.light-mode .btn-danger {
  background: #dc2626;
  color: #fff;
  border: 1px solid #7f1d1d;
}

/* ğŸ§® Ø§Ù„Ø­Ø§Ø³Ø¨Ø© ÙˆØ­Ø§Ø³Ø¨Ø© Ø§Ù„ÙƒØ§Ø´ */
body.light-mode .calc,
body.light-mode .cash-calc {
  background: #f9fafb;
  border: 1px solid var(--border);
  border-radius: 14px;
  color: var(--text);
  box-shadow: 0 4px 14px rgba(0,0,0,0.06);
}
body.light-mode .calc-display {
  background: #f1f5f9;
  color: #1e293b;
  font-size: 22px;
  font-weight: 700;
  border: 1px solid var(--border);
}
body.light-mode .calc-grid button {
  background: linear-gradient(180deg,#f9fafb,#e5e7eb);
  border: 1px solid var(--border);
  color: #1f2937;
  font-weight: 700;
}
body.light-mode .calc-grid button.op {
  background: linear-gradient(135deg,#2f8a6b,#144d3a);
  color: #fff;
}
body.light-mode .calc-grid button.eq {
  background: linear-gradient(135deg,#166c52,#0f3b2e);
  color: #fff;
  font-weight: 800;
}
body.light-mode .calc-grid button[data-k="C"] {
  background: #dc2626;
  color: #fff;
}

/* ğŸ“‹ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª */
body.light-mode #notesBox {
  background: #f9fafb;
  color: var(--text);
  border: 1px solid var(--border);
  box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
}

/* ğŸ“Š Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ù…ØºÙ„Ù‚Ø© */
body.light-mode .closed-row {
  background-color: rgba(243,244,246,0.9);
  color: #1e293b;
}

/* ğŸ¯ Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù */
body.light-mode td.variance {
  font-weight: 700;
}
body.light-mode td.variance[style*="#22c55e"],
body.light-mode .good { color: var(--good) !important; }
body.light-mode td.variance[style*="#ef4444"],
body.light-mode .bad { color: var(--bad) !important; }
body.light-mode td.variance[style*="#f5c542"],
body.light-mode .neutral { color: var(--accent) !important; }

/* âš™ï¸ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© */
body.light-mode * {
  transition: background 0.4s ease, color 0.4s ease, border-color 0.4s ease;
}
</style>

<style>
/* ğŸŒ¿ Royal Emerald Refined Edition */
body.light-mode {
  --bg: #f9fafb;
  --bg2: #ffffffcc;
  --panel: rgba(255,255,255,0.95);
  --panel-strong: rgba(255,255,255,0.98);
  --border: #374151;
  --text: #000000;
  --muted: #374151;
  --primary: #144d3a;
  --primary-2: #2f8a6b;
  --good: #15803d;
  --bad: #dc2626;
  --dark-gray: #374151;

  background: var(--bg);
  color: var(--text);
  transition: background 0.6s ease, color 0.6s ease, filter 0.6s ease;
}

/* âœ… Ø¨Ø·Ø§Ù‚Ø§Øª ÙˆØ£Ù„ÙˆØ§Ø­ */
body.light-mode .card,
body.light-mode header,
body.light-mode .metric-card {
  background: var(--panel);
  color: var(--text);
  border: 1px solid var(--border);
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

/* ğŸ“Š Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
body.light-mode table {
  border-collapse: collapse;
  border: 1px solid var(--border);
  background-color: #f9fafb;
}
body.light-mode thead th {
  background-color: #e5e7eb;
  color: var(--text);
  font-weight: 800;
  border-bottom: 2px solid var(--border);
}
body.light-mode tbody tr:nth-child(even) {
  background-color: #ffffff;
}
body.light-mode tbody tr:nth-child(odd) {
  background-color: #f3f4f6;
}
body.light-mode td, body.light-mode th {
  border: 1px solid var(--border);
  color: var(--text);
}
body.light-mode td[contenteditable] {
  background: #ffffff;
  border: 1px solid var(--border);
  color: var(--text);
}
body.light-mode td[contenteditable]:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 2px rgba(20,77,58,0.3) inset;
}

/* ğŸ§­ Ø§Ù„Ù†ØµÙˆØµ ÙˆØ§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† */
body.light-mode .brand-line,
body.light-mode .header-left .title,
body.light-mode .header-left .subtitle,
body.light-mode .last-update {
  color: var(--dark-gray);
}

/* ğŸ”˜ Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
body.light-mode .btn-blue,
body.light-mode .btn-gold {
  background: linear-gradient(135deg, var(--primary-2), var(--primary));
  color: #fff; /* Ø§Ù„Ø£Ø¨ÙŠØ¶ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø£Ø®Ø¶Ø± ÙŠØ¨Ù‚Ù‰ */
  border: 1px solid var(--border);
  box-shadow: 0 3px 8px rgba(20,77,58,0.25);
}
body.light-mode .btn-blue:hover,
body.light-mode .btn-gold:hover {
  background: linear-gradient(135deg,#166c52,#0f3b2e);
  box-shadow: 0 0 10px rgba(20,77,58,0.3), 0 0 6px rgba(47,138,107,0.25) inset;
}
body.light-mode .btn-danger {
  background: #dc2626;
  color: #fff;
  border: 1px solid #7f1d1d;
}

/* ğŸ§® Ø§Ù„Ø­Ø§Ø³Ø¨Ø© ÙˆØ­Ø§Ø³Ø¨Ø© Ø§Ù„ÙƒØ§Ø´ */
body.light-mode .calc,
body.light-mode .cash-calc {
  background: #f9fafb;
  border: 1px solid var(--border);
  color: var(--text);
}
body.light-mode .calc-display {
  background: #f1f5f9;
  color: #000000;
  border: 1px solid var(--border);
}
body.light-mode .calc-grid button {
  background: linear-gradient(180deg,#f9fafb,#e5e7eb);
  border: 1px solid var(--border);
  color: #000000;
}
body.light-mode .calc-grid button.op {
  background: linear-gradient(135deg,#2f8a6b,#144d3a);
  color: #fff;
}
body.light-mode .calc-grid button.eq {
  background: linear-gradient(135deg,#166c52,#0f3b2e);
  color: #fff;
}
body.light-mode .calc-grid button[data-k="C"] {
  background: #dc2626;
  color: #fff;
}

/* ğŸ—’ï¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª */
body.light-mode #notesBox {
  background: #f9fafb;
  color: var(--text);
  border: 1px solid var(--border);
  box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
}

/* ğŸ§© Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª ÙˆØ§Ù„Ø±Ù…ÙˆØ² */
body.light-mode i,
body.light-mode svg,
body.light-mode .icon {
  color: #000000;
}
body.light-mode .btn-blue i,
body.light-mode .btn-gold i,
body.light-mode .btn-blue svg,
body.light-mode .btn-gold svg {
  color: #ffffff; /* Ø§Ù„Ø£Ø¨ÙŠØ¶ ÙÙ‚Ø· Ø¯Ø§Ø®Ù„ Ø§Ù„Ø£Ø®Ø¶Ø± */
}

/* ğŸŸ¨ Ø§Ù„Ù†ØµÙˆØµ Ø£Ùˆ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ØµÙØ±Ø§Ø¡ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ØªØªØ­ÙˆÙ„ Ø¥Ù„Ù‰ Ø±Ù…Ø§Ø¯ÙŠ ØºØ§Ù…Ù‚ */
body.light-mode [style*="color:#facc15"],
body.light-mode [style*="color:#fde68a"],
body.light-mode [style*="color:#b8903d"] {
  color: #374151 !important;
}

/* âš™ï¸ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© */
body.light-mode * {
  transition: background 0.4s ease, color 0.4s ease, border-color 0.4s ease;
}

/* Ensure notesBox always writable even if page locked */
#notesBox{pointer-events:auto !important; opacity:1 !important;}
</style>
